{
    "collab_server" : "",
    "contents" : "# Load required libraries\n\nlibrary(EGRET)\nlibrary(dataRetrieval)\nlibrary(rloadest)\nlibrary(EGRETci)\nlibrary(foreach)\nlibrary(doParallel)\nlibrary(iterators)\nlibrary(zoo)\nlibrary(plotrix)\n\n# UPPER TRUCKEE RV AT S UPPER TRUCKEE RD NR UT5, CA\n#siteid: 10336580\n\n# By not setting a fixed start and end date, readNWIS will retrieve all available data\n# Will adjust to desired dates below.\nStartDate <- \"\"       # 1980-03-01\nEndDate <- \"\"\n\n# Get pure Q time series using the rloadest function (EGRET adds 0.1% of the period's mean discharge to 0 flow days\nQ <- readNWISDaily(\"10336580\",startDate=StartDate, endDate=EndDate)\n\n# Look at flow record start and end dates\nrange(Q$Date)\n#  \"1990-05-12\" \"2011-09-30\"\n\nlength(Q$Q[Q$Q==0])\n# 0\n\n# In write-up, make a comment about the number of 0-flow adjusted days, \n# or else include it in a table\n\n# Now get Q data using EGRET function\nsiteNumber <- \"10336580\"\nQParameterCd <- \"00060\"\nDaily <- readNWISDaily(siteNumber, QParameterCd, StartDate, EndDate)\n\n# There are 7812 data points, and 7812 days.\n#\n\n# With the information above, restrict the start and end dates to avoid gaps in the data\nStartDate <- \"1989-12-01\"\nEndDate <- \"2011-09-30\"\nDaily <- readNWISDaily(siteNumber, QParameterCd, StartDate, EndDate)\n\n# Metadata retrieval\nINFO <- readNWISInfo(siteNumber = \"10336580\", parameterCd =\"00060\",interactive=FALSE)\nINFO$staAbbrev <- paste(strsplit(INFO$station_nm,\" \")[[1]][1],strsplit(INFO$station_nm,\" \")[[1]][2])\n\neList <- as.egret(INFO, Daily, NA, NA)\n\n# store the annual series of discharge statistics\nannualSeries <- makeAnnualSeries(eList)\n\n# Set working directory so plots are written to appropriate location\nsubDir <- './Q'\nif (file.exists(subDir)){\n    setwd(file.path(getwd(),subDir))\n} else {\n    dir.create(file.path(getwd(),subDir))\n    setwd(file.path(getwd(),subDir))\n}\n\n# Plotting the results for a single discharge statistic\n# istat can range between 1-8; qUnit = 1: cfs\ntiff(\"Annual_Seven_Day_Min_Flow_UpperTruckee_SouthUT5.tif\", height = 600, width = 800, res=120)\n  plotFlowSingle(eList, istat = 2, qUnit = 1) #, showYLabels=FALSE)\ndev.off()\n\ntiff(\"Annual_Median_Daily_UpperTruckee_SouthUT5.tif\", height = 600, width = 800, res=120)\n  plotFlowSingle(eList, istat = 4, qUnit = 1) #, showYLabels=FALSE)\ndev.off()\n\ntiff(\"Annual_Mean_Daily_UpperTruckee_SouthUT5.tif\", height = 600, width = 800, res=120)\n  plotFlowSingle(eList, istat = 5, qUnit = 1) #, showYLabels=FALSE)\ndev.off()\n\ntiff(\"Annual_30Day_Maximum_Q_UpperTruckee_SouthUT5.tif\", height = 600, width = 800, res=120)\n  plotFlowSingle(eList, istat = 6, qUnit = 1) #, showYLabels=FALSE)\ndev.off()\n\ntiff(\"Annual_7Day_Maximum_Q_UpperTruckee_SouthUT5.tif\", height = 600, width = 800, res=120)\n  plotFlowSingle(eList, istat = 7, qUnit = 1) #, showYLabels=FALSE)\ndev.off()\n\ntiff(\"Annual_Maximum_Q_UpperTruckee_SouthUT5.tif\", height = 600, width = 800, res=120)\n  plotFlowSingle(eList, istat = 8, qUnit = 1) #, showYLabels=FALSE)\ndev.off()\n\n#Plot changes in variability\ntiff(\"SD_Q_window3_UpperTruckee_SouthUT5.tif\", height = 600, width = 800, res=120)\n  plotSDLogQ(eList, window=3)\ndev.off()\n\n#plot daily flow\ntiff(\"Period_Of_Record_Hydrograph_UpperTruckee_SouthUT5.tif\", height = 600, width = 800, res=120)\n  plotQTimeDaily(eList, lwd = 1,qUnit = 1) #, showYLabels=FALSE)\ndev.off()\n\ntiff(\"Period_Of_Record_Hydrograph_LogScale_UpperTruckee_SouthUT5.tif\", height = 600, width = 800, res=120)\n  plotQTimeDaily(eList, lwd = 1,qUnit = 1,logScale=TRUE) #, showYLabels=FALSE)\ndev.off()\n\n#plot several graphics at once\ntiff(\"Plot4_window3_UpperTruckee_SouthUT5.tif\", height = 600, width = 800, res=120)\n  plotFour(eList, window=3)\ndev.off()\n\n\n#############################################\n# Look at trends at specific flow rates\n#############################################\neListNext1 <- setPA(eList, paStart = 1, paLong = 2)\nannualSeries <- makeAnnualSeries(eListNext1)\ntiff(\"Jan-Feb_Flow_Analysis.tif\", height = 600, width = 800, res=120)\nplotFour(eListNext1, qUnit=1, window=3)\ndev.off()\n\n# Try March/April\neListNext2 <- setPA(eList, paStart = 3, paLong = 2)\nannualSeries <- makeAnnualSeries(eListNext2)\ntiff(\"Mar_Apr_Flow_Analysis.tif\", height = 600, width = 800, res=120)\nplotFour(eListNext2, qUnit=1,window=3)\ndev.off()\n\neListNext3 <- setPA(eList, paStart = 5, paLong = 2)\nannualSeries <- makeAnnualSeries(eListNext3)\ntiff(\"May-Jun_Flow_Analysis.tif\", height = 600, width = 800, res=120)\nplotFour(eListNext3, qUnit=1,window=3)\ndev.off()\n\neListNext4 <- setPA(eList, paStart = 1, paLong = 4)\nannualSeries <- makeAnnualSeries(eListNext4)\ntiff(\"Jan-Apr_Flow_Analysis.tif\", height = 600, width = 800, res=120)\nplotFour(eListNext4, qUnit=1,window=3)\ndev.off()\n\neListNext5 <- setPA(eList, paStart = 4, paLong = 2)\nannualSeries <- makeAnnualSeries(eListNext5)\ntiff(\"Apr-May_Flow_Analysis.tif\", height = 600, width = 800, res=120)\nplotFour(eListNext5, qUnit=1,window=3)\ndev.off()\n\n#Try summer months\neListNext6 <- setPA(eList, paStart = 4, paLong = 5)\nannualSeries <- makeAnnualSeries(eListNext6)\ntiff(\"Apr-Sep_Flow_Analysis.tif\", height = 600, width = 800, res=120)\nplotFour(eListNext6, qUnit=1,window=3)\ndev.off()\n\n#Try fall, when flows may show a decrease with time as ag returns would be diminished under Ag\n# dry up.\neListNext7 <- setPA(eList, paStart = 9, paLong = 3)\nannualSeries <- makeAnnualSeries(eListNext7)\ntiff(\"Sep-Nov_Flow_Analysis.tif\", height = 600, width = 800, res=120)\nplotFour(eListNext7, qUnit=1,window=3)\ndev.off()\n\n# Note that this approach of using alternatively named \n# eList's leaves the original intact so that we can use\n# it below without fear of altering it from it's paStart=10\n# and paLong = 12 values.  However, we need to set this up:\n\neList <- setPA(eList, paStart = 10, paLong = 12)\nannualSeries <- makeAnnualSeries(eList)\n#############################################################\n# Restrict the dates to a window with uninterupted flow data\n#############################################################\n\n\n\nstartDate <- \"1990-06-01\"\nendDate <- \"2011-09-30\"\nsiteNumber <- \"10336580\"\nQParameterCd <- \"00060\"\nparameterCd <- \"00631\"  # \"NO3\"\nfilePath<-\"/Users/joed/LTIMP_TA/LTIMP_TA2/EGRET/UT5/\"\nfileName<-\"UT5_NO3.csv\"\nDaily <- readNWISDaily(siteNumber, QParameterCd, startDate, endDate)\n\nSample <- readUserSample(filePath, fileName)\n#Sample <- readNWISSample(siteNumber, parameterCd, startDate, endDate)\nINFO <- readNWISInfo(siteNumber = siteNumber, parameterCd = parameterCd, interactive=FALSE)\nINFO$staAbbrev <- paste(strsplit(INFO$station_nm,\" \")[[1]][1],strsplit(INFO$station_nm,\" \")[[1]][2])\n\n# Have a look at the available range of NO3 data\nrange(Sample$Date)\n#  \"1990-06-07\" \"2011-09-06\"\n\neList <- mergeReport(INFO, Daily, Sample)\n\n# Change the working directory; redirect plot output to NO3 folder\nsetwd(\"..\")\nsubDir <- 'NO3/EGRET_plots'\nif (file.exists(subDir)){\n    setwd(file.path(getwd(),subDir))\n} else {\n    dir.create(file.path(getwd(),subDir), recursive = TRUE)\n    setwd(file.path(getwd(),subDir))\n}\nplotConcTimeDaily(eList)\n\n# Plot water quality data\ntiff(\"Conc_vs_Time_UpperTruckee_SouthUT5.tif\", height = 600, width = 800, res=120)\n  plotConcTime(eList, concMax=0.15)\ndev.off()\n\n# Now, a classic Q-C plot\ntiff(\"Conc-Q_UpperTruckee_UT5_Inorg_N.tif\", height = 600, width = 800, res=120)\n  plotConcQ(eList, logScale=TRUE,concMax=1)\ndev.off()\n\n# The data set as flux values rather than as concentrations\ntiff(\"Flux-Q_UpperTruckee__UT5_Inorg_N.tif\", height = 600, width = 800, res=120)\n  plotFluxQ(eList, fluxUnit=4,fluxMax=1)\ndev.off()\n\n# Monthly boxplots\ntiff(\"Monthly-Conc_BoxPlots_UpperTruckee_UT5_Inorg_N.tif\", height = 600, width = 800, res=120)\n  boxConcMonth(eList, logScale=TRUE, concMax=2)\ndev.off()\n\n# Flow on days sampled vs. all other days\ntiff(\"Flow_on_days_sampled_vs_all_other_days_UpperTruckee_UT5_Inorg_N.tif\", height = 600, width = 800, res=120)\n  boxQTwice(eList, qUnit=1)\ndev.off()\n\n#########################################\n# Now start the Flow-Normalized Analysis\n#########################################\n\n# Build the regression model\neList <- modelEstimation(eList, windowY = 7, windowQ = 2, windowS = 0.5, minNumObs = 100, minNumUncen =50)\nMonthlyResults <- calculateMonthlyResults(eList)\n###############################\n\n##############################\n# Determine which flow rates to use for discharge-specific trends\n\n# Baseflow: mean of the annual 30-day low flows\nbaseQ <- mean(aggregate(Q30 ~ waterYear, data = localDaily, min)[,2])\nbaseQ_txt <- format(baseQ, digits=2)\nbaseQ_txt_cfs <- format(baseQ * 35.315, digits=2)\n\n# mid-range: median flow rate across all years\nmedQ <- median(localDaily$Q)\nmedQ_txt <- format(medQ, digits=2)\nmedQ_txt_cfs <- format(medQ * 35.315, digits=2)\n\n# high flow: get the 25% quantile of each year's maximum Q7\n# This will help ensure (but not guarantee) that every year is well represented in the high-end flows\nhighQ7 <- as.numeric(quantile(aggregate(Q7 ~ waterYear, data = localDaily, max)[,2])[2])\nhighQ7_txt <- format(highQ7, digits=2)\nhighQ7_txt_cfs <- format(highQ7 * 35.315, digits=2)\n\n# The following bit of script generates a figure discussed by Joe in an email on 6/2/17\n# -------------------------------------------------------------------------------------\n\ntiff(\"Discharge_specific_trends_NO3_centered_on_06-01.tif\", height = 600, width = 1200, res=120)\npar(mar=c(4,6,4.1,8))\nplotConcTimeSmooth(eList, q1 = baseQ, q2 = medQ, q3 = highQ7, centerDate='06-01', \n                   yearStart=localDaily$waterYear[1], yearEnd=localDaily$waterYear[nrow(localDaily)], \n                   logScale=TRUE, printLegend=FALSE)\n\n# Determine y position of the legend\n# ----------------------------------\ny_l <- par('usr')[3]\ny_u <- par('usr')[4]\ny_m <- mean(y_l, y_u)\n\n# Use the top version of the legend to add cfs\n\n# legend('bottomleft', c(eval(substitute(expression(paste('Baseflow [',baseQ_txt,' ', m^3~s^-1,'(',baseQ_txt_cfs,' ',ft^3~s^-1,')]',sep=' ')), list(baseQ_txt=baseQ_txt, baseQ_txt_cfs=baseQ_txt_cfs))),\n#                        eval(substitute(expression(paste('Median Flow [',medQ_txt,' ', m^3~s^-1,'(',medQ_txt_cfs,' ',ft^3~s^-1,')]',sep=' ')), list(medQ_txt=medQ_txt, medQ_txt_cfs=medQ_txt_cfs))),\n#                        eval(substitute(expression(paste('High Flow [',highQ7_txt,' ', m^3~s^-1,'(',highQ7_txt_cfs,' ',ft^3~s^-1,')]',sep=' ')), list(highQ7_txt=highQ7_txt, highQ7_txt_cfs=highQ7_txt_cfs)))), \n#                        col=c('black','red','green'), lwd=2, bg='white', bty='n')\n\nlegend('bottomleft', c(eval(substitute(expression(paste('Baseflow (',baseQ_txt,' ', m^3~s^-1,')',sep=' ')), list(baseQ_txt=baseQ_txt))),\n                       eval(substitute(expression(paste('Median Flow (',medQ_txt,' ', m^3~s^-1,')',sep=' ')), list(medQ_txt=medQ_txt))),\n                       eval(substitute(expression(paste('High Flow (',highQ7_txt,' ', m^3~s^-1,')',sep=' ')), list(highQ7_txt=highQ7_txt)))), \n       col=c('black','red','green'), lwd=2, bg='white', bty='n')\n\ndev.off()\n\n# Restore original plotting margins\npar(mar=c(5.1,6.1,4.1,2.1))\n\n# The following bit of script generates a figure discussed by Michael in an email on 6/2/17\n# -----------------------------------------------------------------------------------------\n# Get the row number corresponding to the maximum concentration for each year (bearing in mind that these are 'within group' row numbers)\nout <- aggregate(ConcDay ~ waterYear, data = localDaily, which.max)\n\n# Ensure data is ordered by water year\nout <- out[ order(out$waterYear), ]\n\n# Get a count of the number of days within each of the water years\ntbl <- table(localDaily$waterYear)\n\n# Return the absolute row positions for each water year's max concentration\nout$AbsConcDay <- out$ConcDay + cumsum(c(0,tbl[-length(tbl)]))\n\n# Make a data.frame containing only the rows with each water year's max conc\nout2 <- localDaily[out$AbsConcDay,]\n\n# Gather only the needed data\nout2 <- data.frame(Date=out2$Date, Q=out2$Q, Conc=out2$ConcDay, wyr=out2$waterYear, Julian=yday(as.Date(out2$Date)))\n\n# Need to readjust the Julian day to start on Oct 1 (This function doesn't yet account for leap years)\nout2$JulianWYR <- ifelse(out2$Julian > 273, out2$Julian - 273, 92 + out2$Julian)\n\n# Plot it\ntiff(\"JulianDay_of_Max_NO3_Conc.tif\", height = 600, width = 800, res=120)\nplot(out2$wyr, out2$JulianWYR, pch=16, xlab='Water Year', ylab='Julian Day', yaxs='i', ylim=c(0,370), las=1)\ndev.off()\n\n# In a follow-up email from Michael on 6/7/17, Michael suggested two alterations:\n#  1) Apply a 30-day moving average\n#  2) Use the flow-normalized concentration\n\n# To start with, I'll attempt to apply a 30-day window to the simulated daily concentrations\n\nlocalDaily$ConcDay_30day <- c(rep(rollapply(localDaily$ConcDay, width=30, mean)[1],times=14) , rollapply(localDaily$ConcDay, width=30, mean), rep(rollapply(localDaily$ConcDay, width=30, mean)[length(rollapply(localDaily$ConcDay, width=30, mean))], times=15))\nout_m <- aggregate(ConcDay_30day ~ waterYear, data = localDaily, which.max)\nout_m <- out_m[ order(out_m$waterYear), ]\nout_m$AbsConcDay <- out_m$ConcDay + cumsum(c(0,tbl[-length(tbl)]))\nout_m2 <- localDaily[out_m$AbsConcDay,]\nout_m2 <- data.frame(Date=out_m2$Date, Q=out_m2$Q, Conc30=out_m2$ConcDay_30day, wyr=out_m2$waterYear, Julian=yday(as.Date(out_m2$Date)))\nout_m2$JulianWYR <- ifelse(out_m2$Julian > 273, out_m2$Julian - 273, 92 + out_m2$Julian)\n\ntiff(\"JulianDay_of_Max_NO3_Conc_Using_30_rollingAvg.tif\", height = 600, width = 800, res=120)\nplot(out_m2$wyr, out_m2$JulianWYR, pch=16, xlab='Water Year', ylab='Julian Day', yaxs='i', ylim=c(0,370), las=1)\ndev.off()\n\n\n# Next, I'll try using the flow-normalized concentration (same general code flow as above)\n# First, try plotting flow-normalized concentration:\n# Plot it\ntiff(\"Flow_Normalized_Conc_TC1_NO3.tif\", height = 600, width = 800, res=120)\nplot(as.Date(localDaily$Date), localDaily$FNConc, typ='l', las=1, xlab='Time', ylab='Flow-normalized Concentration')\ndev.off()\n\nout_FN <- aggregate(FNConc ~ waterYear, data = localDaily, which.max)\nout_FN <- out_FN[ order(out_FN$waterYear), ]\nout_FN$AbsConcDay <- out_FN$FNConc + cumsum(c(0,tbl[-length(tbl)]))\nout2_FN <- localDaily[out_FN$AbsConcDay,]\nout2_FN <- data.frame(Date=out2_FN$Date, Q=out2_FN$Q, Conc=out2_FN$FNConc, wyr=out2_FN$waterYear, Julian=yday(as.Date(out2_FN$Date)))\nout2_FN$JulianWYR <- ifelse(out2_FN$Julian > 273, out2_FN$Julian - 273, 92 + out2_FN$Julian)\n\n# Plot it\ntiff(\"JulianDay_of_Max_NO3_Flow_Normalized_Conc.tif\", height = 600, width = 800, res=120)\nplot(out2_FN$wyr, out2_FN$JulianWYR, pch=16, xlab='Water Year', ylab='Julian Day', yaxs='i', ylim=c(0,370), las=1)\ndev.off()\n\n\n# --------------------------------------------------------------------------------------------------------\n# The following script is for a non-standard EGRET plot and instead help generate a plot Michael requested\n\nlocalDaily <- getDaily(eList)\n\n# Will need to adjust the date range below based on each gages unique start/stop dates\nearly_decade <- subset(localDaily, localDaily$Date > as.Date('1990-09-30') & localDaily$Date < as.Date('2000-10-01'))\nrecent_decade <- subset(localDaily, localDaily$Date > as.Date('2001-09-30'))\n\n\nearly_decade_monthly_mn <- aggregate(ConcDay ~ MonthSeq, data = early_decade, 'mean')\nrecent_decade_monthly_mn <- aggregate(ConcDay ~ MonthSeq, data = recent_decade, 'mean')\n\n# early_decade_monthly_mn$month <- format(seq(as.Date('1972-10-01'), as.Date('1982-09-30'), by='month'), '%b')\nearly_decade_monthly_mn$month <- rep(c(10:12,1:9), times=10)\nearly_decade_mon_mn <- aggregate(ConcDay ~ month, data = early_decade_monthly_mn, 'mean')\nearly_decade_mon_sd <- aggregate(ConcDay ~ month, data = early_decade_monthly_mn, 'sd')\nearly_decade_mon_mn <- early_decade_mon_mn[c(10:12,1:9),]\nearly_decade_mon_sd <- early_decade_mon_sd[c(10:12,1:9),]\n\nrecent_decade_monthly_mn$month <- rep(c(10:12,1:9), times=10)\nrecent_decade_mon_mn <- aggregate(ConcDay ~ month, data = recent_decade_monthly_mn, 'mean')\nrecent_decade_mon_sd <- aggregate(ConcDay ~ month, data = recent_decade_monthly_mn, 'sd')\nrecent_decade_mon_mn <- recent_decade_mon_mn[c(10:12,1:9),]\nrecent_decade_mon_sd <- recent_decade_mon_sd[c(10:12,1:9),]\n\n\nmdat2 <- matrix(c(early_decade_mon_mn$ConcDay, recent_decade_mon_mn$ConcDay),\n                nrow=2,ncol = 12, byrow=TRUE,\n                dimnames = list(c(\"1990-2000\", \"2001-2011\"),\n                                c(format(seq(as.Date('1973-10-01'), as.Date('1974-09-01'), by='month'), '%b'))))\n\n# Be sure to adjust the legend's first decade start and stop year correctly\nmx <- max(c((early_decade_mon_mn$ConcDay + early_decade_mon_sd$ConcDay), (recent_decade_mon_mn$ConcDay + recent_decade_mon_sd$ConcDay)))\n\ntiff(\"timing_shift_in_NO3_conc_monthly_means.tif\", height=800, width=900, res=130)\npar(mar=c(3,5,2,1))\nx <- barplot(mdat2, beside=TRUE, las=1, ylim=c(0,mx), col = c(\"lightblue\", \"mistyrose\"))\nabline(h=0)\narrows(x0=x[1,], y0=early_decade_mon_mn$ConcDay - early_decade_mon_sd$ConcDay, x1=x[1,], y1=early_decade_mon_mn$ConcDay + early_decade_mon_sd$ConcDay, angle=90, length=0.04, code=3)\narrows(x0=x[2,], y0=recent_decade_mon_mn$ConcDay - recent_decade_mon_sd$ConcDay, x1=x[2,], y1=recent_decade_mon_mn$ConcDay + recent_decade_mon_sd$ConcDay, angle=90, length=0.04, code=3)\nmtext(side=2, expression(paste(NO[3],', mg ',L^-1,sep='')), line=3)\nlegend(x=25, y=0.9 * mx, c(\"1990-2000\", \"2001-2011\"), pch=c(22,22), pt.cex=2, pt.bg=c(\"lightblue\", \"mistyrose\"), bty='n', xpd=TRUE)\ndev.off()\n\n\n# Now attempting a Wilcox Test (aka Mann-Whitney-Wilcoxon Rank Sum test)\n# ----------------------------------------------------------------------\nearly_jan <- subset(early_decade_monthly_mn, month==1)\nrecent_jan <- subset(recent_decade_monthly_mn, month==1)\nUT5_NO3_conc_jan_wilcox <- wilcox.test(recent_jan$ConcDay, early_jan$ConcDay, exact=TRUE, conf.int = TRUE, conf.level = 0.9)\n\nearly_feb <- subset(early_decade_monthly_mn, month==2)\nrecent_feb <- subset(recent_decade_monthly_mn, month==2)\nUT5_NO3_conc_feb_wilcox <- wilcox.test(recent_feb$ConcDay, early_feb$ConcDay, exact=TRUE, conf.int = TRUE, conf.level = 0.9)\n\nearly_mar <- subset(early_decade_monthly_mn, month==3)\nrecent_mar <- subset(recent_decade_monthly_mn, month==3)\nUT5_NO3_conc_mar_wilcox <- wilcox.test(recent_mar$ConcDay, early_mar$ConcDay, exact=TRUE, conf.int = TRUE, conf.level = 0.9)\n\nearly_apr <- subset(early_decade_monthly_mn, month==4)\nrecent_apr <- subset(recent_decade_monthly_mn, month==4)\nUT5_NO3_conc_apr_wilcox <- wilcox.test(recent_apr$ConcDay, early_apr$ConcDay, exact=TRUE, conf.int = TRUE, conf.level = 0.9)\n\nearly_may <- subset(early_decade_monthly_mn, month==5)\nrecent_may <- subset(recent_decade_monthly_mn, month==5)\nUT5_NO3_conc_may_wilcox <- wilcox.test(recent_may$ConcDay, early_may$ConcDay, exact=TRUE, conf.int = TRUE, conf.level = 0.9)\n\nearly_jun <- subset(early_decade_monthly_mn, month==6)\nrecent_jun <- subset(recent_decade_monthly_mn, month==6)\nUT5_NO3_conc_jun_wilcox <- wilcox.test(recent_jun$ConcDay, early_jun$ConcDay, exact=TRUE, conf.int = TRUE, conf.level = 0.9)\n\nearly_jul <- subset(early_decade_monthly_mn, month==7)\nrecent_jul <- subset(recent_decade_monthly_mn, month==7)\nUT5_NO3_conc_jul_wilcox <- wilcox.test(recent_jul$ConcDay, early_jul$ConcDay, exact=TRUE, conf.int = TRUE, conf.level = 0.9)\n\nearly_aug <- subset(early_decade_monthly_mn, month==8)\nrecent_aug <- subset(recent_decade_monthly_mn, month==8)\nUT5_NO3_conc_aug_wilcox <- wilcox.test(recent_aug$ConcDay, early_aug$ConcDay, exact=TRUE, conf.int = TRUE, conf.level = 0.9)\n\nearly_sep <- subset(early_decade_monthly_mn, month==9)\nrecent_sep <- subset(recent_decade_monthly_mn, month==9)\nUT5_NO3_conc_sep_wilcox <- wilcox.test(recent_sep$ConcDay, early_sep$ConcDay, exact=TRUE, conf.int = TRUE, conf.level = 0.9)\n\nearly_oct <- subset(early_decade_monthly_mn, month==10)\nrecent_oct <- subset(recent_decade_monthly_mn, month==10)\nUT5_NO3_conc_oct_wilcox <- wilcox.test(recent_oct$ConcDay, early_oct$ConcDay, exact=TRUE, conf.int = TRUE, conf.level = 0.9)\n\nearly_nov <- subset(early_decade_monthly_mn, month==11)\nrecent_nov <- subset(recent_decade_monthly_mn, month==11)\nUT5_NO3_conc_nov_wilcox <- wilcox.test(recent_nov$ConcDay, early_nov$ConcDay, exact=TRUE, conf.int = TRUE, conf.level = 0.9)\n\nearly_dec <- subset(early_decade_monthly_mn, month==12)\nrecent_dec <- subset(recent_decade_monthly_mn, month==12)\nUT5_NO3_conc_dec_wilcox <- wilcox.test(recent_dec$ConcDay, early_dec$ConcDay, exact=TRUE, conf.int = TRUE, conf.level = 0.9)\n\nConc_compare <- data.frame(chng_est=c(UT5_NO3_conc_oct_wilcox$est,\n                                      UT5_NO3_conc_nov_wilcox$est,\n                                      UT5_NO3_conc_dec_wilcox$est,\n                                      UT5_NO3_conc_jan_wilcox$est,\n                                      UT5_NO3_conc_feb_wilcox$est,\n                                      UT5_NO3_conc_mar_wilcox$est,\n                                      UT5_NO3_conc_apr_wilcox$est,\n                                      UT5_NO3_conc_may_wilcox$est,\n                                      UT5_NO3_conc_jun_wilcox$est,\n                                      UT5_NO3_conc_jul_wilcox$est,\n                                      UT5_NO3_conc_aug_wilcox$est,\n                                      UT5_NO3_conc_sep_wilcox$est),\n                           low_conf=c(UT5_NO3_conc_oct_wilcox$conf.int[1],\n                                      UT5_NO3_conc_nov_wilcox$conf.int[1],\n                                      UT5_NO3_conc_dec_wilcox$conf.int[1],\n                                      UT5_NO3_conc_jan_wilcox$conf.int[1],\n                                      UT5_NO3_conc_feb_wilcox$conf.int[1],\n                                      UT5_NO3_conc_mar_wilcox$conf.int[1],\n                                      UT5_NO3_conc_apr_wilcox$conf.int[1],\n                                      UT5_NO3_conc_may_wilcox$conf.int[1],\n                                      UT5_NO3_conc_jun_wilcox$conf.int[1],\n                                      UT5_NO3_conc_jul_wilcox$conf.int[1],\n                                      UT5_NO3_conc_aug_wilcox$conf.int[1],\n                                      UT5_NO3_conc_sep_wilcox$conf.int[1]),\n                           up_conf=c(UT5_NO3_conc_oct_wilcox$conf.int[2],\n                                     UT5_NO3_conc_nov_wilcox$conf.int[2],\n                                     UT5_NO3_conc_dec_wilcox$conf.int[2],\n                                     UT5_NO3_conc_jan_wilcox$conf.int[2],\n                                     UT5_NO3_conc_feb_wilcox$conf.int[2],\n                                     UT5_NO3_conc_mar_wilcox$conf.int[2],\n                                     UT5_NO3_conc_apr_wilcox$conf.int[2],\n                                     UT5_NO3_conc_may_wilcox$conf.int[2],\n                                     UT5_NO3_conc_jun_wilcox$conf.int[2],\n                                     UT5_NO3_conc_jul_wilcox$conf.int[2],\n                                     UT5_NO3_conc_aug_wilcox$conf.int[2],\n                                     UT5_NO3_conc_sep_wilcox$conf.int[2]))\n\nwrite.table(Conc_compare, \"UT5_NO3_conc_wilcox.txt\", quote=FALSE, row.names=FALSE)\n\nrng <- max(abs(c(Conc_compare$up_conf, Conc_compare$low_conf)))\ntiff(\"UT5_NO3_conc_shift_wilcox_Vert_Bars.tif\", height=600, width=800, res=130)\npar(mar=c(4,5,0.5,0.5))\nplot(seq(1:12), Conc_compare$chng_est, typ='h', lend=1, lwd=15, col='white', xaxt='n', xlim=c(1,13), ylim=c(-rng, rng), xlab=\"Month\", ylab=expression(paste(\"Median Concentration Change, mg  \",L^-1,sep='')), las=1)\nplotCI(seq(1:12), Conc_compare$chng_est, ui=Conc_compare$up_conf, li=Conc_compare$low_conf, pch=16, add=TRUE)\nabline(h=0)\naxis(side=1,at=seq(1,12,by=1), labels=format(c(seq(as.Date(\"2000-10-01\"), as.Date(\"2000-12-01\"), by=\"month\"), seq(as.Date(\"2000-01-01\"), as.Date(\"2000-09-01\"), by=\"month\")),'%b'), las=2)\nlegend('topright', c(\"Median difference\", \"90% Confidence Interval for the Median\"), pch=c(16,NA), lwd=c(NA,1), pt.cex=c(1,NA), pt.bg=c('black',NA), bty='n', bg='white')\ndev.off()\n\n\n# Now do the load\n# ---------------\nearly_decade_monthly_flx <- aggregate(FluxDay ~ MonthSeq, data = early_decade, 'sum')\nrecent_decade_monthly_flx <- aggregate(FluxDay ~ MonthSeq, data = recent_decade, 'sum')\n\n# early_decade_monthly_mn$month <- format(seq(as.Date('1972-10-01'), as.Date('1982-09-30'), by='month'), '%b')\nearly_decade_monthly_flx$month <- rep(c(10:12,1:9), times=10)\nearly_decade_mon_mn_flx <- aggregate(FluxDay ~ month, data = early_decade_monthly_flx, 'mean')\nearly_decade_mon_sd_flx <- aggregate(FluxDay ~ month, data = early_decade_monthly_flx, 'sd')\nearly_decade_mon_mn_flx <- early_decade_mon_mn_flx[c(10:12,1:9),]\nearly_decade_mon_sd_flx <- early_decade_mon_sd_flx[c(10:12,1:9),]\n\nrecent_decade_monthly_flx$month <- rep(c(10:12,1:9), times=10)\nrecent_decade_mon_mn_flx <- aggregate(FluxDay ~ month, data = recent_decade_monthly_flx, 'mean')\nrecent_decade_mon_sd_flx <- aggregate(FluxDay ~ month, data = recent_decade_monthly_flx, 'sd')\nrecent_decade_mon_mn_flx <- recent_decade_mon_mn_flx[c(10:12,1:9),]\nrecent_decade_mon_sd_flx <- recent_decade_mon_sd_flx[c(10:12,1:9),]\n\nmdat3 <- matrix(c(early_decade_mon_mn_flx$FluxDay, recent_decade_mon_mn_flx$FluxDay),\n                nrow=2,ncol = 12, byrow=TRUE,\n                dimnames = list(c(\"1990-2000\", \"2001-2011\"),\n                                c(format(seq(as.Date('1973-10-01'), as.Date('1974-09-01'), by='month'), '%b'))))\n\nmx <- max(c((early_decade_mon_mn_flx$FluxDay + early_decade_mon_sd_flx$FluxDay), (recent_decade_mon_mn_flx$FluxDay + recent_decade_mon_sd_flx$FluxDay)))\ntiff(\"timing_shift_in_NO3_load_monthly_means.tif\", height=800, width=900, res=130)\nx <- barplot(mdat3, beside=TRUE, las=1, ylim=c(0,mx), col = c(\"lightblue\", \"mistyrose\"))\nabline(h=0)\narrows(x0=x[1,], y0=early_decade_mon_mn_flx$FluxDay - early_decade_mon_sd_flx$FluxDay, x1=x[1,], y1=early_decade_mon_mn_flx$FluxDay + early_decade_mon_sd_flx$FluxDay, angle=90, length=0.04, code=3)\narrows(x0=x[2,], y0=recent_decade_mon_mn_flx$FluxDay - recent_decade_mon_sd_flx$FluxDay, x1=x[2,], y1=recent_decade_mon_mn_flx$FluxDay + recent_decade_mon_sd_flx$FluxDay, angle=90, length=0.04, code=3)\nmtext(side=2, expression(paste(NO[3],', kg ',month^-1,sep='')), line=2.5)\nlegend(x=30, y=0.9 * mx, c(\"1990-2000\", \"2001-2011\"), pch=c(22,22), pt.cex=2, pt.bg=c(\"lightblue\", \"mistyrose\"), bty='n', xpd=TRUE)\ndev.off()\n\n# Apply Wilcox.text to the monthly loads here...\nearly_jan_flx <- subset(early_decade_monthly_flx, month==1)\nrecent_jan_flx <- subset(recent_decade_monthly_flx, month==1)\nUT5_NO3_flux_jan_wilcox <- wilcox.test(recent_jan_flx$FluxDay, early_jan_flx$FluxDay, exact=TRUE, conf.int = TRUE, conf.level = 0.9)\n\nearly_feb_flx <- subset(early_decade_monthly_flx, month==2)\nrecent_feb_flx <- subset(recent_decade_monthly_flx, month==2)\nUT5_NO3_flux_feb_wilcox <- wilcox.test(recent_feb_flx$FluxDay, early_feb_flx$FluxDay, exact=TRUE, conf.int = TRUE, conf.level = 0.9)\n\nearly_mar_flx <- subset(early_decade_monthly_flx, month==3)\nrecent_mar_flx <- subset(recent_decade_monthly_flx, month==3)\nUT5_NO3_flux_mar_wilcox <- wilcox.test(recent_mar_flx$FluxDay, early_mar_flx$FluxDay, exact=TRUE, conf.int = TRUE, conf.level = 0.9)\n\nearly_apr_flx <- subset(early_decade_monthly_flx, month==4)\nrecent_apr_flx <- subset(recent_decade_monthly_flx, month==4)\nUT5_NO3_flux_apr_wilcox <- wilcox.test(recent_apr_flx$FluxDay, early_apr_flx$FluxDay, exact=TRUE, conf.int = TRUE, conf.level = 0.9)\n\nearly_may_flx <- subset(early_decade_monthly_flx, month==5)\nrecent_may_flx <- subset(recent_decade_monthly_flx, month==5)\nUT5_NO3_flux_may_wilcox <- wilcox.test(recent_may_flx$FluxDay, early_may_flx$FluxDay, exact=TRUE, conf.int = TRUE, conf.level = 0.9)\n\nearly_jun_flx <- subset(early_decade_monthly_flx, month==6)\nrecent_jun_flx <- subset(recent_decade_monthly_flx, month==6)\nUT5_NO3_flux_jun_wilcox <- wilcox.test(recent_jun_flx$FluxDay, early_jun_flx$FluxDay, exact=TRUE, conf.int = TRUE, conf.level = 0.9)\n\nearly_jul_flx <- subset(early_decade_monthly_flx, month==7)\nrecent_jul_flx <- subset(recent_decade_monthly_flx, month==7)\nUT5_NO3_flux_jul_wilcox <- wilcox.test(recent_jul_flx$FluxDay, early_jul_flx$FluxDay, exact=TRUE, conf.int = TRUE, conf.level = 0.9)\n\nearly_aug_flx <- subset(early_decade_monthly_flx, month==8)\nrecent_aug_flx <- subset(recent_decade_monthly_flx, month==8)\nUT5_NO3_flux_aug_wilcox <- wilcox.test(recent_aug_flx$FluxDay, early_aug_flx$FluxDay, exact=TRUE, conf.int = TRUE, conf.level = 0.9)\n\nearly_sep_flx <- subset(early_decade_monthly_flx, month==9)\nrecent_sep_flx <- subset(recent_decade_monthly_flx, month==9)\nUT5_NO3_flux_sep_wilcox <- wilcox.test(recent_sep_flx$FluxDay, early_sep_flx$FluxDay, exact=TRUE, conf.int = TRUE, conf.level = 0.9)\n\nearly_oct_flx <- subset(early_decade_monthly_flx, month==10)\nrecent_oct_flx <- subset(recent_decade_monthly_flx, month==10)\nUT5_NO3_flux_oct_wilcox <- wilcox.test(recent_oct_flx$FluxDay, early_oct_flx$FluxDay, exact=TRUE, conf.int = TRUE, conf.level = 0.9)\n\nearly_nov_flx <- subset(early_decade_monthly_flx, month==11)\nrecent_nov_flx <- subset(recent_decade_monthly_flx, month==11)\nUT5_NO3_flux_nov_wilcox <- wilcox.test(recent_nov_flx$FluxDay, early_nov_flx$FluxDay, exact=TRUE, conf.int = TRUE, conf.level = 0.9)\n\nearly_dec_flx <- subset(early_decade_monthly_flx, month==12)\nrecent_dec_flx <- subset(recent_decade_monthly_flx, month==12)\nUT5_NO3_flux_dec_wilcox <- wilcox.test(recent_dec_flx$FluxDay, early_dec_flx$FluxDay, exact=TRUE, conf.int = TRUE, conf.level = 0.9)\n\n\nFlux_compare <- data.frame(chng_est=c(UT5_NO3_flux_oct_wilcox$est,\n                                      UT5_NO3_flux_nov_wilcox$est,\n                                      UT5_NO3_flux_dec_wilcox$est,\n                                      UT5_NO3_flux_jan_wilcox$est,\n                                      UT5_NO3_flux_feb_wilcox$est,\n                                      UT5_NO3_flux_mar_wilcox$est,\n                                      UT5_NO3_flux_apr_wilcox$est,\n                                      UT5_NO3_flux_may_wilcox$est,\n                                      UT5_NO3_flux_jun_wilcox$est,\n                                      UT5_NO3_flux_jul_wilcox$est,\n                                      UT5_NO3_flux_aug_wilcox$est,\n                                      UT5_NO3_flux_sep_wilcox$est),\n                           low_conf=c(UT5_NO3_flux_oct_wilcox$conf.int[1],\n                                      UT5_NO3_flux_nov_wilcox$conf.int[1],\n                                      UT5_NO3_flux_dec_wilcox$conf.int[1],\n                                      UT5_NO3_flux_jan_wilcox$conf.int[1],\n                                      UT5_NO3_flux_feb_wilcox$conf.int[1],\n                                      UT5_NO3_flux_mar_wilcox$conf.int[1],\n                                      UT5_NO3_flux_apr_wilcox$conf.int[1],\n                                      UT5_NO3_flux_may_wilcox$conf.int[1],\n                                      UT5_NO3_flux_jun_wilcox$conf.int[1],\n                                      UT5_NO3_flux_jul_wilcox$conf.int[1],\n                                      UT5_NO3_flux_aug_wilcox$conf.int[1],\n                                      UT5_NO3_flux_sep_wilcox$conf.int[1]),\n                           up_conf=c(UT5_NO3_flux_oct_wilcox$conf.int[2],\n                                     UT5_NO3_flux_nov_wilcox$conf.int[2],\n                                     UT5_NO3_flux_dec_wilcox$conf.int[2],\n                                     UT5_NO3_flux_jan_wilcox$conf.int[2],\n                                     UT5_NO3_flux_feb_wilcox$conf.int[2],\n                                     UT5_NO3_flux_mar_wilcox$conf.int[2],\n                                     UT5_NO3_flux_apr_wilcox$conf.int[2],\n                                     UT5_NO3_flux_may_wilcox$conf.int[2],\n                                     UT5_NO3_flux_jun_wilcox$conf.int[2],\n                                     UT5_NO3_flux_jul_wilcox$conf.int[2],\n                                     UT5_NO3_flux_aug_wilcox$conf.int[2],\n                                     UT5_NO3_flux_sep_wilcox$conf.int[2]))\n\nwrite.table(Flux_compare, \"UT5_NO3_flux_wilcox.txt\", quote=FALSE, row.names=FALSE)\n\nrng_flx <- max(abs(c(Flux_compare$up_conf, Flux_compare$low_conf)))\ntiff(\"UT5_NO3_flux_shift_wilcox_Vert_Bars.tif\", height=600, width=800, res=130)\npar(mar=c(4,5,0.5,0.5))\nplot(seq(1:12), Flux_compare$chng_est, typ='h', lend=1, lwd=15, col='white', xaxt='n', xlim=c(1,13), ylim=c(-rng_flx, rng_flx), xlab=\"Month\", ylab=expression(paste(\"Median Flux Change, kg\",sep='')), las=1)\nplotCI(seq(1:12), Flux_compare$chng_est, ui=Flux_compare$up_conf, li=Flux_compare$low_conf, pch=16, add=TRUE)\nabline(h=0)\naxis(side=1,at=seq(1,12,by=1), labels=format(c(seq(as.Date(\"2000-10-01\"), as.Date(\"2000-12-01\"), by=\"month\"), seq(as.Date(\"2000-01-01\"), as.Date(\"2000-09-01\"), by=\"month\")),'%b'), las=2)\nlegend('topright', c(\"Median difference\", \"90% Confidence Interval for the Median\"), pch=c(16,NA), lwd=c(NA,1), pt.cex=c(1,NA), pt.bg=c('black',NA), bty='n', bg='white')\ndev.off()\n\n\n# End of non-standard EGRET plot section requested by Michael\n# --------------------------------------------------------------------------------------------------------\n\n\n\n# Plot the annual average concentration and annual flow-normalized concentration\ntiff(\"Ann_Avg_Conc_&_Ann_Flow_Normalized_Conc_UpperTruckee_SouthUT5.tif\", height = 600, width = 800, res=120)\n  plotConcHist(eList, plotFlowNorm=TRUE)\ndev.off()\n\n# Plot the annual flux and annual flow-normalized flux\ntiff(\"Ann_Flux_&_Ann_Flow_Normalized_Flux_UpperTruckee_SouthUT5.tif\", height = 600, width = 800, res=120)\n  plotFluxHist(eList, plotFlowNorm = TRUE) # fluxMax) # fluxMax\ndev.off()\n\n# Look for a trend change:\ntableChange(eList, fluxUnit=6, yearPoints=c(1990,2000,2011))\n\n#UPPER TRUCKEE RV AT S UPPER TRUCKEE RD NR MEYERS \n#Inorganic nitrogen (nitrate and nitrite)\n#Water Year \n#\n#Concentration trends\n#time span       change     slope    change     slope\n#mg/L   mg/L/yr        %       %/yr\n#\n#1991  to  1996   1.6e-05   3.3e-06     0.081     0.016\n#1991  to  2001  -0.00083  -8.3e-05      -4.1     -0.41\n#1991  to  2006    -0.005  -0.00033       -24      -1.6\n#1991  to  2011   -0.0074  -0.00037       -36      -1.8\n#1996  to  2001  -0.00085  -0.00017      -4.2     -0.83\n#1996  to  2006    -0.005    -5e-04       -25      -2.5\n#1996  to  2011   -0.0074  -0.00049       -36      -2.4\n#2001  to  2006   -0.0041  -0.00083       -21      -4.3\n#2001  to  2011   -0.0065  -0.00065       -34      -3.4\n#2006  to  2011   -0.0024  -0.00048       -16      -3.1\n#\n#\n#Flux Trends\n#time span          change        slope       change        slope\n#10^3 tons/yr   10^3 tons/yr /yr      %         %/yr\n#1991  to  1996     -4.9e-05     -9.8e-06         -9.4         -1.9\n#1991  to  2001     -2.7e-05     -2.7e-06         -5.2        -0.52\n#1991  to  2006     -7.2e-05     -4.8e-06          -14        -0.92\n#1991  to  2011     -0.00013     -6.3e-06          -24         -1.2\n#1996  to  2001      2.2e-05      4.4e-06          4.6         0.92\n#1996  to  2006     -2.3e-05     -2.3e-06         -4.9        -0.49\n#1996  to  2011     -7.8e-05     -5.2e-06          -16         -1.1\n#2001  to  2006     -4.5e-05       -9e-06         -9.1         -1.8\n#2001  to  2011       -1e-04       -1e-05          -20           -2\n#2006  to  2011     -5.4e-05     -1.1e-05          -12         -2.4\n#\n#Generate out-of-the-box diagnostic plots\ntiff(\"fluxBiasMulti_UpperTruckee__UT5_Inorg_N.tif\", height = 1200, width = 1200, res=120)\n fluxBiasMulti(eList, moreTitle = \"WRTDS\")\ndev.off()\n\ntiff(\"Modeled_Daily_Conc_wObservations_UpperTruckee__UT5_Inorg_N.tif\", height = 800, width = 1000, res=120)\n plotConcTimeDaily(eList, concMax=0.2)\ndev.off()\n\n# Exploring model behavior and adjusting model parameters\ntiff(\"Contours_UpperTruckee_UT5_Inorg_N.tif\", height = 700, width = 1000, res=120)\n plotContours(eList, qBottom=0.03,qTop=5,yearStart=1990,yearEnd=2011, contourLevels=seq(0.0,0.28,by=0.005), color.palette = colorRampPalette(c(\"violet\", \"purple\", \"blue\", \"cyan\", \"green\", \"yellow\", \"orange\", \"red\"))) \ndev.off()\n\ntiff(\"Log_Contours_UpperTruckee__UT5_Inorg_N.tif\", height = 700, width = 1000, res=120)\n plotContours(eList, qBottom=0.03, qTop=8, yearStart=1990, yearEnd=2011, contourLevels=seq(-6.4,-1.5,by=0.1), color.palette = colorRampPalette(c(\"violet\", \"purple\", \"blue\", \"cyan\", \"green\", \"yellow\", \"orange\", \"red\")), whatSurface=1) \ndev.off()\n\ntiff(\"StdErr_of_Log_Contours_UpperTruckee__UT5_Inorg_N.tif\", height = 700, width = 1000, res=120)\n plotContours(eList, qBottom=0.03, qTop=8, yearStart=1990, yearEnd=2011, contourLevels=seq(0.35,0.88,by=0.01), color.palette = colorRampPalette(c(\"violet\", \"purple\", \"blue\", \"cyan\", \"green\", \"yellow\", \"orange\", \"red\")), whatSurface=2) \ndev.off()\n\ntiff(\"Contours_Difference_Inorg__UT5_N.tif\", height = 700, width = 1000, res=120)\n plotDiffContours(eList, 1990,2011,0.03,8,maxDiff=0.1)\ndev.off()\n\ntiff(\"Contours_PercentDifference_UT_UT5_Inorg_N.tif\", height = 700, width = 1000, res=120)\n plotDiffContours(eList, 1990,2011,0.03,8, maxDiff=100, plotPercent=TRUE)\ndev.off()\n\nplotDiffContours2 <- function (eList, year0, year1, qBottom, qTop, maxDiff, whatSurface = 3, \n    tcl = 0.1, qUnit = 2, span = 60, pval = 0.05, printTitle = TRUE, \n    plotPercent = FALSE, vert1 = NA, vert2 = NA, horiz = NA, \n    flowDuration = TRUE, yTicks = NA, tick.lwd = 2, lwd = 1, \n    cex.main = 0.95, cex.axis = 1, customPar = FALSE, color.palette = colorRampPalette(c(\"blue\", \n        \"white\", \"red\")), ...) \n{\n    localINFO <- getInfo(eList)\n    localDaily <- getDaily(eList)\n    localsurfaces <- getSurfaces(eList)\n    if (is.numeric(qUnit)) {\n        qUnit <- qConst[shortCode = qUnit][[1]]\n    }\n    else if (is.character(qUnit)) {\n        qUnit <- qConst[qUnit][[1]]\n    }\n    if (!customPar) {\n        par(oma = c(6, 1, 6, 0))\n        par(mar = c(5, 5, 4, 2) + 0.1)\n    }\n    surfaceName <- c(\"log of Concentration\", \"Standard Error of log(C)\", \n        \"Concentration\")\n    j <- 3\n    j <- if (whatSurface == 1) \n        1\n    else j\n    j <- if (whatSurface == 2) \n        2\n    else j\n    surf <- localsurfaces\n    bottomLogQ <- localINFO$bottomLogQ\n    stepLogQ <- localINFO$stepLogQ\n    nVectorLogQ <- localINFO$nVectorLogQ\n    bottomYear <- localINFO$bottomYear\n    stepYear <- localINFO$stepYear\n    nVectorYear <- localINFO$nVectorYear\n    start0 <- ((year0 - bottomYear) * 16) + 1\n    end0 <- start0 + 16\n    start1 <- ((year1 - bottomYear) * 16) + 1\n    end1 <- start1 + 16\n    if (plotPercent) {\n        diff <- (surf[, start1:end1, j] - surf[, start0:end0, \n            j]) * 100/surf[, start0:end0, j]\n    }\n    else {\n        diff <- surf[, start1:end1, j] - surf[, start0:end0, \n            j]\n    }\n    difft <- t(diff)\n    if (length(maxDiff) == 1) {\n        surfaceSpan <- c(-maxDiff, maxDiff)\n    }\n    else {\n        surfaceSpan <- range(maxDiff)\n    }\n    contourLevels <- pretty(surfaceSpan, n = 50)\n    x <- seq(0, 1, stepYear)\n    y <- ((1:nVectorLogQ) * stepLogQ) + (bottomLogQ - stepLogQ)\n    yLQ <- y\n    qFactor <- qUnit@qUnitFactor\n    y <- exp(y) * qFactor\n    numX <- length(x)\n    numY <- length(y)\n    if (is.na(yTicks[1])) {\n        qBottom <- max(0.9 * y[1], qBottom)\n        qTop <- min(1.1 * y[numY], qTop)\n        yTicks <- logPretty3(qBottom, qTop)\n        yTicks2 <- c(0.028,0.056,0.141,0.283,0.566,1.415,2.831,5.663,14.15,28.31,56.63,141.5) #cfs\n    }\n    xTicks <- c(0, 0.0848, 0.1642, 0.249, 0.331, 0.416, 0.498, \n        0.583, 0.668, 0.75, 0.835, 0.917, 1)\n    xLabels <- c(\"Jan1\", \"Feb1\", \"Mar1\", \"Apr1\", \"May1\", \"Jun1\", \n        \"Jul1\", \"Aug1\", \"Sep1\", \"Oct1\", \"Nov1\", \"Dec1\", \"Jan1\")\n    nxTicks <- length(xTicks)\n    nYTicks <- length(yTicks)\n    numDays <- length(localDaily$Day)\n    freq <- rep(0, nVectorLogQ)\n    plotTitle <- if (printTitle) \n        paste(localINFO$shortName, \" \", localINFO$paramShortName, \n            \"\\nEstimated\", surfaceName[j], \"change from\", year0, \n            \"to\", year1)\n    else \"\"\n    if (flowDuration) {\n        durSurf <- rep(0, 17 * nVectorLogQ)\n        dim(durSurf) <- c(17, nVectorLogQ)\n        centerDays <- seq(1, 388, 22.9)\n        centerDays <- floor(centerDays)\n        for (ix in 1:17) {\n            startDay <- centerDays[ix] - span\n            endDay <- centerDays[ix] + span\n            goodDays <- seq(startDay, endDay, 1)\n            goodDays <- ifelse(goodDays > 0, goodDays, goodDays + \n                365)\n            goodDays <- ifelse(goodDays < 366, goodDays, goodDays - \n                365)\n            numDays <- length(localDaily$Day)\n            isGood <- localDaily$Day %in% goodDays\n            spanDaily <- data.frame(localDaily, isGood)\n            spanDaily <- subset(spanDaily, isGood)\n            n <- length(spanDaily$Day)\n            LogQ <- spanDaily$LogQ\n            for (jQ in 1:nVectorLogQ) {\n                ind <- ifelse(LogQ < yLQ[jQ], 1, 0)\n                freq[jQ] <- sum(ind)/n\n            }\n            durSurf[ix, ] <- freq\n        }\n        plevels <- c(pval, 1 - pval)\n        pct1 <- format(plevels[1] * 100, digits = 2)\n        pct2 <- format(plevels[2] * 100, digits = 2)\n        firstLine <- paste(localINFO$shortName, \"  \", localINFO$paramShortName, \n            sep = \"\")\n        secondLine <- if (plotPercent) {\n            paste(\"\\nEstimated\", surfaceName[j], \"percent change from\", \n                year0, \"to\", year1)\n        }\n        else {\n            paste(\"\\nEstimated\", surfaceName[j], \"change from\", \n                year0, \"to\", year1)\n        }\n        thirdLine <- paste(\"\\nBlack lines are\", pct1, \"and\", \n            pct2, \"flow percentiles\")\n        plotTitle <- paste(firstLine, secondLine, thirdLine)\n    }\n    vectorNone <- c(year0, log(yTicks[1], 10) - 1, year1, log(yTicks[1], \n        10) - 1)\n    v1 <- if (is.na(vert1)) \n        vectorNone\n    else c(vert1, log(yTicks[1], 10), vert1, log(yTicks[nYTicks], \n        10))\n    v2 <- if (is.na(vert2)) \n        vectorNone\n    else c(vert2, log(yTicks[1], 10), vert2, log(yTicks[nYTicks], \n        10))\n    h1 <- if (is.na(horiz)) \n        vectorNone\n    else c(year0, log(horiz, 10), year1, log(horiz, 10))\n    deltaY <- (log(yTicks[length(yTicks)], 10) - log(yTicks[1], \n        10))/25\n    deltaX <- (1)/25\n    yLab <- qUnit@qUnitExpress\n    filled.contour(x, log(y, 10), difft, levels = contourLevels, \n        xlim = c(0, 1), ylim = c(log(yTicks[1], 10), log(yTicks[nYTicks], \n            10)), xlab = \"\", ylab = yLab, xaxs = \"i\", yaxs = \"i\", \n        cex.main = cex.main, plot.axes = {\n            axis(1, tcl = 0, at = xTicks, labels = xLabels, cex.axis = 0.9 * \n                cex.axis)\n            axis(2, tcl = 0, las = 1, at = log(yTicks, 10), labels = yTicks, \n                cex.axis = cex.axis)\n            axis(3, tcl = 0, at = xTicks, labels = FALSE)\n            axis(4, tcl = 0, at = log(yTicks2, 10), labels = c(\"1\",\"2\",\"5\",\"10\",\"20\",\"50\",\"100\",\"200\",\"500\",\"1000\",\"2000\",\"5000\"))    #edm: yTicks -> yTicks2, added labels\n            if (flowDuration) \n                contour(x, log(y, 10), durSurf, add = TRUE, drawlabels = FALSE, \n                  levels = plevels, lwd = lwd,lty=2)  #adjust the 95% confidence intervals here\n            segments(v1[1], v1[2], v1[3], v1[4])\n            segments(v2[1], v2[2], v2[3], v2[4])\n            segments(h1[1], h1[2], h1[3], h1[4])\n            segments(xTicks, rep(log(yTicks[1], 10), length(xTicks)), \n                xTicks, rep(grconvertY(grconvertY(par(\"usr\")[3], \n                  from = \"user\", to = \"inches\") + tcl, from = \"inches\", \n                  to = \"user\"), length(xTicks)), lwd = tick.lwd)\n            segments(xTicks, rep(log(yTicks[nYTicks], 10), length(xTicks)), \n                xTicks, rep(grconvertY(grconvertY(par(\"usr\")[4], \n                  from = \"user\", to = \"inches\") - tcl, from = \"inches\", \n                  to = \"user\"), length(xTicks)), lwd = tick.lwd)\n            segments(rep(0, length(yTicks)), log(yTicks, 10), \n                rep(grconvertX(grconvertX(par(\"usr\")[1], from = \"user\", \n                  to = \"inches\") + tcl, from = \"inches\", to = \"user\"), \n                  length(yTicks)), log(yTicks, 10), lwd = tick.lwd)\n            segments(rep(grconvertX(grconvertX(par(\"usr\")[2], \n                from = \"user\", to = \"inches\") - tcl, from = \"inches\", \n                to = \"user\"), length(yTicks)), log(yTicks, 10), \n                rep(1, length(yTicks)), log(yTicks, 10), lwd = tick.lwd)\n        }, color.palette = color.palette, ...)\n        \n        #try adding contours\n        par(new=T, mar=c(5.1,5.1,4.1,9.1))\n        contour(x, log(y, 10), difft, levels = seq(-100,200,by=50),xlim=c(0,1), ylim = c(log(yTicks[1], 10), log(yTicks[nYTicks],10)),\n                xaxs = \"i\",yaxs=\"i\",xaxt=\"n\",yaxt=\"n\",labcex=1,method=c(\"flattest\",\"edge\")) #add=TRUE)\n    if (printTitle) \n        title(plotTitle, outer = TRUE, cex.main = cex.main, line = -3)\n}\n\n\ntiff(\"Contours_PercentDifference2_Inorg_N_UpperTruckee_UT5_DIN.tif\", height = 700, width = 1000, res=120)\n plotDiffContours2(eList, 1990,2011,0.05,8, maxDiff=c(-100,100), plotPercent=TRUE, lwd=3, color.palette=colorRampPalette(c(\"blue\",\"lightblue\",\"white\", \"orange\", \"red\")),tick.lwd = 1)\ndev.off()\n\nSample$WY <- trunc(Sample$DecYear+0.25) \ntiff(\"Monthly_Boxplot_UT_UT5_Inorg_N.tif\", height = 700, width = 1000, res=120)\n par(mar=c(4,6,0.5,0.5))\n boxplot(Sample$ConcAve~Sample$WY,log=\"y\",varwidth=TRUE,ylim=c(0.001,0.4),yaxs=\"i\",xlab=\"Water Year\",las=1) \n mtext(side=2, expression(paste(\"Concentration, Inorganic Nitrogen, in mg  \",L^-1,sep=\"\")),line=4)\ndev.off()\n\n#################  Using the plotConcQSmooth function\n###########\n#First do flow duration analysis\nflowDuration(eList, centerDate = \"06-01\", qUnit = 2, span = 30)\ndate1 <- \"1991-06-01\"\ndate2 <- \"2000-05-6-01\"\ndate3 <- \"2010-06-01\"\nqLow= baseQ\nqHigh=highQ7\n\ntiff(\"UT5_Date_Discharge_NO3_conc_no_log.tif\",height = 700, width = 1000, res=120)\nplotConcQSmooth(eList,date1, date2, date3,qLow, qHigh, logScale=FALSE,printLegend =TRUE,legendLeft=0,legendTop=0,printTitle=TRUE)\ndev.off()\n\n\n\n# ---------------------------\n# Now run the EGRETci package\n# ---------------------------\n\n# Change working directory\nsetwd(\"..\")\nsubDir <- 'EGRETci_plots'\nif (file.exists(subDir)){\n    setwd(file.path(getwd(),subDir))\n} else {\n    dir.create(file.path(getwd(),subDir), recursive = TRUE)\n    setwd(file.path(getwd(),subDir))\n}\n\n#Interactive function to set up trend analysis:\ncaseSetUp <- trendSetUp(eList, \n                        year1=1991, \n                        year2=2011, \n                        nBoot = 200, \n                        bootBreak = 100, \n                        blockLength = 200)\neBoot <- wBT(eList, caseSetUp, fileName =\"outputText.txt\")\n\n#Should we reject Ho that Flow Normalized Concentration Trend = 0 ? Reject Ho\n#best estimate is -0.00736 mg/L\n#Lower and Upper 90% CIs -0.01041 -0.00282\n#also 95% CIs-0.01124 -0.00248\n#and 50% CIs -0.00833 -0.00485\n#* Note p-value should be considered to be < stated value\n#approximate two-sided p-value for Conc      0.02\n#Likelihood that Flow Normalized Concentration is trending up =    0.00495 is trending down =      0.995\n#\n#Should we reject Ho that Flow Normalized Flux Trend = 0 ? Do Not Reject Ho\n#best estimate is -0.0001151 10^6 kg/year\n#Lower and Upper 90% CIs -2.76e-04  3.75e-05\n#also 95% CIs -3.47e-04  5.32e-05\n#and 50% CIs -1.69e-04 -3.50e-05\n#approximate two-sided p-value for Flux       0.3\n#Likelihood that Flow Normalized Flux is trending up = 0.153 is trending down= 0.847\n#\n#Upward trend in concentration is highly unlikely\n#Upward trend in flux is unlikely\n#Downward trend in concentration is highly likely\n#Downward trend in flux is likely\n#\n\nsaveEGRETci(eList, eBoot, caseSetUp, fileName = \"EGRETci_output_NO3\")\n#\nplotHistogramTrend2 <-\nfunction (eBoot, caseSetUp, eList, xSeq = seq(-100, 100, 10), \n    flux = TRUE, printTitle = TRUE, cex.main = 1.1, col.fill = \"grey\", xlim = c(-100,100),\n    ...) \n{\n    bootOut <- eBoot$bootOut\n    INFO <- eList$INFO\n    if (flux) {\n        xFlux <- eBoot$xFlux\n        change <- 100 * bootOut$estF/bootOut$baseFlux\n        reps <- 100 * xFlux/bootOut$baseFlux\n        xlabel <- \"Flux trend, in %\"\n        titleWord <- \"Flux\"\n    }\n    else {\n        xConc <- eBoot$xConc\n        change <- 100 * bootOut$estC/bootOut$baseConc\n        reps <- 100 * xConc/bootOut$baseConc\n        xlabel <- \"Concentration trend, in %\"\n        titleWord <- \"Concentration\"\n    }\n    titleToPrint <- ifelse(printTitle, paste(\"Histogram of trend in\", \n        INFO$paramShortName, \"\\n\", titleWord, \"Normalized Concentration:\", \n        caseSetUp$year1, \"to\", caseSetUp$year2, \"\\n\", INFO$shortName), \n        \"\")\n    hist(reps, breaks = xSeq, yaxs = \"i\", xaxs = \"i\", tcl = 0.5, \n        main = titleToPrint, freq = FALSE, xlab = xlabel, col = col.fill, \n        cex.main = cex.main, xlim=xlim, ...)\n    abline(v = change, lwd = 3, lty = 2)\n    abline(v = 0, lwd = 3)\n    box()\n    axis(3, tcl = 0.5, labels = FALSE)\n    axis(4, tcl = 0.5, labels = FALSE)\n}\n\ntiff(\"histo_NO3_UpTruck_Trend_conc_flux.tif\", height = 700, width = 1200, res=120)\n par(mfrow=c(1,2))\n plotHistogramTrend2(eBoot, caseSetUp, eList, flux=FALSE, xSeq = seq(-8000,8000,5),las=1,xlim=c(-100,100))\n abline(h=0)\n \n plotHistogramTrend2(eBoot, caseSetUp, eList, flux=TRUE, xSeq = seq(-50000,50000,5),las=1)\n abline(h=0)\ndev.off()\n#\nnBoot <- 200\nblockLength <- 200\ncoreOut <- 4 #Number of cores to leave out of processing tasks\n\nwidthCI <- 95\nciLower <- (50-(widthCI/2))/100\nciUpper <- (50+(widthCI/2))/100\nprobs <- c(ciLower,ciUpper)\n#\nnCores <- detectCores() - coreOut\ncl <- makeCluster(nCores)\nregisterDoParallel(cl)\nrepAnnual <- foreach(n = 1:nBoot,.packages=c('EGRETci')) %dopar% {\n   annualResults <- bootAnnual(eList, blockLength)  \n}\nstopCluster(cl)\n#\nCIAnnualResults <- ciBands(eList, repAnnual, probs)\nconc.poly.x <- c(CIAnnualResults$Year,rev(CIAnnualResults$Year))\nconc.poly.y <- c(CIAnnualResults$FNConcLow,rev(CIAnnualResults$FNConcHigh))\nflux.poly.x <- c(CIAnnualResults$Year,rev(CIAnnualResults$Year))\nflux.poly.y <- c(CIAnnualResults$FNFluxLow*365,rev(CIAnnualResults$FNFluxHigh*365))\n#\ntiff(\"Ann_Avg_Conc_&_Ann_Flow_Normalized_Conc_Boot_UpperTruckee_InorgN.tif\", height = 500, width = 600, res=110)\n plotConcHistBoot(eList, CIAnnualResults, plotFlowNorm=TRUE, showYLabels=TRUE, showYAxis=TRUE,col=4)\n polygon(x=conc.poly.x, y=conc.poly.y, col=rgb(24,116,205,40,max=255),border=NA)\ndev.off()\n#\ntiff(\"Ann_Flux_&_Ann_Flow_Normalized_Flux_Boot_UpperTruckee_InorgN.tif\", height = 500, width = 600, res=110)\n plotFluxHistBoot(eList, fluxUnit=13, CIAnnualResults, showYLabels=TRUE, showYAxis=TRUE, col=4)\n polygon(x=flux.poly.x, y=flux.poly.y, col=rgb(24,116,205,40,max=255),border=NA)\ndev.off()\n#\nsetSweave(\"UT5_NO3_Conc_EGRETCI\",7,7)\nplotConcHistBoot(eList, CIAnnualResults, plotFlowNorm=TRUE, showYLabels=TRUE, showYAxis=TRUE,col=4)\npolygon(x=conc.poly.x, y=conc.poly.y, col=rgb(24,116,205,40,max=255),border=NA)\ndev.off()\ngraphics.off()\n\nsetSweave(\"UT5_NO3_Flux_EGRETCI\",7,7)\nplotFluxHistBoot(eList, fluxUnit=13, CIAnnualResults, showYLabels=TRUE, showYAxis=TRUE, col=4)\npolygon(x=flux.poly.x, y=flux.poly.y, col=rgb(24,116,205,40,max=255),border=NA)\ngraphics.off()\n\n\n\n\nsaveEGRETci(eList, eBoot, fileName=\"N_Boot_NO3\")\nsave(repAnnual,file=\"RepAnnual\")\n#\n\n\n\n\n#############################################################################\n# Now do Orthophosphate, water, filtered, milligrams per liter as phosphorus\n#############################################################################\n\nparameterCd <- \"00671\"\nstartDate <- \"1990-06-01\"\nendDate <- \"2011-09-30\"\n\nDaily <- readNWISDaily(siteNumber, QParameterCd, startDate, endDate)\n\nfileName <- \"UT5_OP.csv\"\nSample <- readUserSample(filePath, fileName)\n#Sample <- readNWISSample(siteNumber, parameterCd, startDate=startDate, endDate=endDate)\nINFO <- readNWISInfo(siteNumber = siteNumber, parameterCd = parameterCd, interactive=FALSE)\nINFO$staAbbrev <- paste(strsplit(INFO$station_nm,\" \")[[1]][1],strsplit(INFO$station_nm,\" \")[[1]][2])\n\neList <- NULL\neList <- mergeReport(INFO, Daily, Sample)\n\n# Change the working directory; redirect plot output to OP folder\nsetwd(\"../../\")\nsubDir <- 'OP/EGRET_plots'\nif (file.exists(subDir)){\n    setwd(file.path(getwd(),subDir))\n} else {\n    dir.create(file.path(getwd(),subDir), recursive=TRUE)\n    setwd(file.path(getwd(),subDir))\n}\n\n# Plot water quality data\ntiff(\"Conc_vs_Time_Ortho_P.tif\", height = 600, width = 800, res=120)\n  plotConcTime(eList)\ndev.off()\n\n# Now, a classic Q-C plot\ntiff(\"Conc-Q_UpperTruckee_-UT5_Ortho_P.tif\", height = 600, width = 800, res=120)\n  plotConcQ(eList, logScale=TRUE)\ndev.off()\n\n# The data set as flux values rather than as concentrations\ntiff(\"Flux-Q_UpperTruckee_UT5_Ortho_P.tif\", height = 600, width = 800, res=120)\n  plotFluxQ(eList, fluxUnit=4)\ndev.off()\n\n# Monthly boxplots\ntiff(\"Monthly-Conc_BoxPlots_UpperTruckee_UT5_Ortho_P.tif\", height = 600, width = 800, res=120)\n  boxConcMonth(eList, logScale=TRUE)\ndev.off()\n\n# Flow on days sampled vs. all other days\ntiff(\"Flow_on_days_sampled_vs_all_other_days_UpperTruckee_UT5_Ortho_P.tif\", height = 600, width = 800, res=120)\n  boxQTwice(eList, qUnit=1)\ndev.off()\n\n#####################################################\n# Now start the Flow-Normalized Analysis for Ortho P\n#####################################################\n\n# Build the regression model\neList <- modelEstimation(eList, windowY = 7, windowQ = 2, windowS = 0.5, minNumObs = 100, minNumUncen =50)\n\nMonthlyResults <- calculateMonthlyResults(eList)\n\n# Plot the annual average concentration and annual flow-normalized concentration\ntiff(\"Ann_Avg_Conc_&_Ann_Flow_Normalized_Conc_UpperTruckee_SupTruckUT5_OP.tif\", height = 600, width = 800, res=120)\n  plotConcHist(eList, plotFlowNorm=TRUE)\ndev.off()\n\n# Plot the annual flux and annual flow-normalized flux\ntiff(\"Ann_Flux_&_Ann_Flow_Normalized_Flux_UPperTruckee_SupTruckUT5_OP.tif\", height = 600, width = 800, res=120)\n  plotFluxHist(eList, plotFlowNorm = TRUE) # fluxMax) # fluxMax\ndev.off()\n\n###################\n# Determine which flow rates to use for discharge-specific trends\n\n# Baseflow: mean of the annual 30-day low flows\nbaseQ <- mean(aggregate(Q30 ~ waterYear, data = localDaily, min)[,2])\nbaseQ_txt <- format(baseQ, digits=2)\nbaseQ_txt_cfs <- format(baseQ * 35.315, digits=2)\n\n# mid-range: median flow rate across all years\nmedQ <- median(localDaily$Q)\nmedQ_txt <- format(medQ, digits=2)\nmedQ_txt_cfs <- format(medQ * 35.315, digits=2)\n\n# high flow: get the 25% quantile of each year's maximum Q7\n# This will help ensure (but not guarantee) that every year is well represented in the high-end flows\nhighQ7 <- as.numeric(quantile(aggregate(Q7 ~ waterYear, data = localDaily, max)[,2])[2])\nhighQ7_txt <- format(highQ7, digits=2)\nhighQ7_txt_cfs <- format(highQ7 * 35.315, digits=2)\n\n# The following bit of script generates a figure discussed by Joe in an email on 6/2/17\n# -------------------------------------------------------------------------------------\n\ntiff(\"Discharge_specific_trends_OP_centered_on_06-01.tif\", height = 600, width = 1200, res=120)\npar(mar=c(4,6,4.1,8))\nplotConcTimeSmooth(eList, q1 = baseQ, q2 = medQ, q3 = highQ7, centerDate='06-01', \n                   yearStart=localDaily$waterYear[1], yearEnd=localDaily$waterYear[nrow(localDaily)], \n                   logScale=TRUE, printLegend=FALSE)\n\n# Determine y position of the legend\n# ----------------------------------\ny_l <- par('usr')[3]\ny_u <- par('usr')[4]\ny_m <- mean(y_l, y_u)\n\n# Use the top version of the legend to add cfs\n\n# legend('bottomleft', c(eval(substitute(expression(paste('Baseflow [',baseQ_txt,' ', m^3~s^-1,'(',baseQ_txt_cfs,' ',ft^3~s^-1,')]',sep=' ')), list(baseQ_txt=baseQ_txt, baseQ_txt_cfs=baseQ_txt_cfs))),\n#                        eval(substitute(expression(paste('Median Flow [',medQ_txt,' ', m^3~s^-1,'(',medQ_txt_cfs,' ',ft^3~s^-1,')]',sep=' ')), list(medQ_txt=medQ_txt, medQ_txt_cfs=medQ_txt_cfs))),\n#                        eval(substitute(expression(paste('High Flow [',highQ7_txt,' ', m^3~s^-1,'(',highQ7_txt_cfs,' ',ft^3~s^-1,')]',sep=' ')), list(highQ7_txt=highQ7_txt, highQ7_txt_cfs=highQ7_txt_cfs)))), \n#                        col=c('black','red','green'), lwd=2, bg='white', bty='n')\n\nlegend('bottomleft', c(eval(substitute(expression(paste('Baseflow (',baseQ_txt,' ', m^3~s^-1,')',sep=' ')), list(baseQ_txt=baseQ_txt))),\n                       eval(substitute(expression(paste('Median Flow (',medQ_txt,' ', m^3~s^-1,')',sep=' ')), list(medQ_txt=medQ_txt))),\n                       eval(substitute(expression(paste('High Flow (',highQ7_txt,' ', m^3~s^-1,')',sep=' ')), list(highQ7_txt=highQ7_txt)))), \n       col=c('black','red','green'), lwd=2, bg='white', bty='n')\n\ndev.off()\n\n# Restore original plotting margins\npar(mar=c(5.1,6.1,4.1,2.1))\n\n# The following bit of script generates a figure discussed by Michael in an email on 6/2/17\n# -----------------------------------------------------------------------------------------\n# Get the row number corresponding to the maximum concentration for each year (bearing in mind that these are 'within group' row numbers)\nout <- aggregate(ConcDay ~ waterYear, data = localDaily, which.max)\n\n# Ensure data is ordered by water year\nout <- out[ order(out$waterYear), ]\n\n# Get a count of the number of days within each of the water years\ntbl <- table(localDaily$waterYear)\n\n# Return the absolute row positions for each water year's max concentration\nout$AbsConcDay <- out$ConcDay + cumsum(c(0,tbl[-length(tbl)]))\n\n# Make a data.frame containing only the rows with each water year's max conc\nout2 <- localDaily[out$AbsConcDay,]\n\n# Gather only the needed data\nout2 <- data.frame(Date=out2$Date, Q=out2$Q, Conc=out2$ConcDay, wyr=out2$waterYear, Julian=yday(as.Date(out2$Date)))\n\n# Need to readjust the Julian day to start on Oct 1 (This function doesn't yet account for leap years)\nout2$JulianWYR <- ifelse(out2$Julian > 273, out2$Julian - 273, 92 + out2$Julian)\n\n# Plot it\ntiff(\"JulianDay_of_Max_OP_Conc.tif\", height = 600, width = 800, res=120)\nplot(out2$wyr, out2$JulianWYR, pch=16, xlab='Water Year', ylab='Julian Day', yaxs='i', ylim=c(0,370), las=1)\ndev.off()\n\n# In a follow-up email from Michael on 6/7/17, Michael suggested two alterations:\n#  1) Apply a 30-day moving average\n#  2) Use the flow-normalized concentration\n\n# To start with, I'll attempt to apply a 30-day window to the simulated daily concentrations\n\nlocalDaily$ConcDay_30day <- c(rep(rollapply(localDaily$ConcDay, width=30, mean)[1],times=14) , rollapply(localDaily$ConcDay, width=30, mean), rep(rollapply(localDaily$ConcDay, width=30, mean)[length(rollapply(localDaily$ConcDay, width=30, mean))], times=15))\nout_m <- aggregate(ConcDay_30day ~ waterYear, data = localDaily, which.max)\nout_m <- out_m[ order(out_m$waterYear), ]\nout_m$AbsConcDay <- out_m$ConcDay + cumsum(c(0,tbl[-length(tbl)]))\nout_m2 <- localDaily[out_m$AbsConcDay,]\nout_m2 <- data.frame(Date=out_m2$Date, Q=out_m2$Q, Conc30=out_m2$ConcDay_30day, wyr=out_m2$waterYear, Julian=yday(as.Date(out_m2$Date)))\nout_m2$JulianWYR <- ifelse(out_m2$Julian > 273, out_m2$Julian - 273, 92 + out_m2$Julian)\n\ntiff(\"JulianDay_of_Max_OP_Conc_Using_30_rollingAvg.tif\", height = 600, width = 800, res=120)\nplot(out_m2$wyr, out_m2$JulianWYR, pch=16, xlab='Water Year', ylab='Julian Day', yaxs='i', ylim=c(0,370), las=1)\ndev.off()\n\n\n# Next, I'll try using the flow-normalized concentration (same general code flow as above)\n# First, try plotting flow-normalized concentration:\n# Plot it\ntiff(\"Flow_Normalized_Conc_UT5_OP.tif\", height = 600, width = 800, res=120)\nplot(as.Date(localDaily$Date), localDaily$FNConc, typ='l', las=1, xlab='Time', ylab='Flow-normalized Concentration')\ndev.off()\n\nout_FN <- aggregate(FNConc ~ waterYear, data = localDaily, which.max)\nout_FN <- out_FN[ order(out_FN$waterYear), ]\nout_FN$AbsConcDay <- out_FN$FNConc + cumsum(c(0,tbl[-length(tbl)]))\nout2_FN <- localDaily[out_FN$AbsConcDay,]\nout2_FN <- data.frame(Date=out2_FN$Date, Q=out2_FN$Q, Conc=out2_FN$FNConc, wyr=out2_FN$waterYear, Julian=yday(as.Date(out2_FN$Date)))\nout2_FN$JulianWYR <- ifelse(out2_FN$Julian > 273, out2_FN$Julian - 273, 92 + out2_FN$Julian)\n\n# Plot it\ntiff(\"JulianDay_of_Max_OP_Flow_Normalized_Conc.tif\", height = 600, width = 800, res=120)\nplot(out2_FN$wyr, out2_FN$JulianWYR, pch=16, xlab='Water Year', ylab='Julian Day', yaxs='i', ylim=c(0,370), las=1)\ndev.off()\n\n\n\n# --------------------------------------------------------------------------------------------------------\n# The following script is for a non-standard EGRET plot and instead help generate a plot Michael requested\n\nlocalDaily <- getDaily(eList)\n\n# Will need to adjust the date range below based on each gages unique start/stop dates\nearly_decade <- subset(localDaily, localDaily$Date > as.Date('1990-09-30') & localDaily$Date < as.Date('2000-10-01'))\nrecent_decade <- subset(localDaily, localDaily$Date > as.Date('2001-09-30'))\n\n\nearly_decade_monthly_mn <- aggregate(ConcDay ~ MonthSeq, data = early_decade, 'mean')\nrecent_decade_monthly_mn <- aggregate(ConcDay ~ MonthSeq, data = recent_decade, 'mean')\n\n# early_decade_monthly_mn$month <- format(seq(as.Date('1972-10-01'), as.Date('1982-09-30'), by='month'), '%b')\nearly_decade_monthly_mn$month <- rep(c(10:12,1:9), times=10)\nearly_decade_mon_mn <- aggregate(ConcDay ~ month, data = early_decade_monthly_mn, 'mean')\nearly_decade_mon_sd <- aggregate(ConcDay ~ month, data = early_decade_monthly_mn, 'sd')\nearly_decade_mon_mn <- early_decade_mon_mn[c(10:12,1:9),]\nearly_decade_mon_sd <- early_decade_mon_sd[c(10:12,1:9),]\n\nrecent_decade_monthly_mn$month <- rep(c(10:12,1:9), times=10)\nrecent_decade_mon_mn <- aggregate(ConcDay ~ month, data = recent_decade_monthly_mn, 'mean')\nrecent_decade_mon_sd <- aggregate(ConcDay ~ month, data = recent_decade_monthly_mn, 'sd')\nrecent_decade_mon_mn <- recent_decade_mon_mn[c(10:12,1:9),]\nrecent_decade_mon_sd <- recent_decade_mon_sd[c(10:12,1:9),]\n\n\nmdat2 <- matrix(c(early_decade_mon_mn$ConcDay, recent_decade_mon_mn$ConcDay),\n                nrow=2,ncol = 12, byrow=TRUE,\n                dimnames = list(c(\"1990-2000\", \"2001-2011\"),\n                                c(format(seq(as.Date('1973-10-01'), as.Date('1974-09-01'), by='month'), '%b'))))\n\n# Be sure to adjust the legend's first decade start and stop year correctly\nmx <- max(c((early_decade_mon_mn$ConcDay + early_decade_mon_sd$ConcDay), (recent_decade_mon_mn$ConcDay + recent_decade_mon_sd$ConcDay)))\n\ntiff(\"timing_shift_in_OP_conc_monthly_means.tif\", height=800, width=900, res=130)\npar(mar=c(3,5,2,1))\nx <- barplot(mdat2, beside=TRUE, las=1, ylim=c(0,mx), col = c(\"lightblue\", \"mistyrose\"))\nabline(h=0)\narrows(x0=x[1,], y0=early_decade_mon_mn$ConcDay - early_decade_mon_sd$ConcDay, x1=x[1,], y1=early_decade_mon_mn$ConcDay + early_decade_mon_sd$ConcDay, angle=90, length=0.04, code=3)\narrows(x0=x[2,], y0=recent_decade_mon_mn$ConcDay - recent_decade_mon_sd$ConcDay, x1=x[2,], y1=recent_decade_mon_mn$ConcDay + recent_decade_mon_sd$ConcDay, angle=90, length=0.04, code=3)\nmtext(side=2, expression(paste(NO[3],', mg ',L^-1,sep='')), line=3)\nlegend(x=25, y=0.9 * mx, c(\"1990-2000\", \"2001-2011\"), pch=c(22,22), pt.cex=2, pt.bg=c(\"lightblue\", \"mistyrose\"), bty='n', xpd=TRUE)\ndev.off()\n\n\n# Now attempting a Wilcox Test (aka Mann-Whitney-Wilcoxon Rank Sum test)\n# ----------------------------------------------------------------------\nearly_jan <- subset(early_decade_monthly_mn, month==1)\nrecent_jan <- subset(recent_decade_monthly_mn, month==1)\nUT5_OP_conc_jan_wilcox <- wilcox.test(recent_jan$ConcDay, early_jan$ConcDay, exact=TRUE, conf.int = TRUE, conf.level = 0.9)\n\nearly_feb <- subset(early_decade_monthly_mn, month==2)\nrecent_feb <- subset(recent_decade_monthly_mn, month==2)\nUT5_OP_conc_feb_wilcox <- wilcox.test(recent_feb$ConcDay, early_feb$ConcDay, exact=TRUE, conf.int = TRUE, conf.level = 0.9)\n\nearly_mar <- subset(early_decade_monthly_mn, month==3)\nrecent_mar <- subset(recent_decade_monthly_mn, month==3)\nUT5_OP_conc_mar_wilcox <- wilcox.test(recent_mar$ConcDay, early_mar$ConcDay, exact=TRUE, conf.int = TRUE, conf.level = 0.9)\n\nearly_apr <- subset(early_decade_monthly_mn, month==4)\nrecent_apr <- subset(recent_decade_monthly_mn, month==4)\nUT5_OP_conc_apr_wilcox <- wilcox.test(recent_apr$ConcDay, early_apr$ConcDay, exact=TRUE, conf.int = TRUE, conf.level = 0.9)\n\nearly_may <- subset(early_decade_monthly_mn, month==5)\nrecent_may <- subset(recent_decade_monthly_mn, month==5)\nUT5_OP_conc_may_wilcox <- wilcox.test(recent_may$ConcDay, early_may$ConcDay, exact=TRUE, conf.int = TRUE, conf.level = 0.9)\n\nearly_jun <- subset(early_decade_monthly_mn, month==6)\nrecent_jun <- subset(recent_decade_monthly_mn, month==6)\nUT5_OP_conc_jun_wilcox <- wilcox.test(recent_jun$ConcDay, early_jun$ConcDay, exact=TRUE, conf.int = TRUE, conf.level = 0.9)\n\nearly_jul <- subset(early_decade_monthly_mn, month==7)\nrecent_jul <- subset(recent_decade_monthly_mn, month==7)\nUT5_OP_conc_jul_wilcox <- wilcox.test(recent_jul$ConcDay, early_jul$ConcDay, exact=TRUE, conf.int = TRUE, conf.level = 0.9)\n\nearly_aug <- subset(early_decade_monthly_mn, month==8)\nrecent_aug <- subset(recent_decade_monthly_mn, month==8)\nUT5_OP_conc_aug_wilcox <- wilcox.test(recent_aug$ConcDay, early_aug$ConcDay, exact=TRUE, conf.int = TRUE, conf.level = 0.9)\n\nearly_sep <- subset(early_decade_monthly_mn, month==9)\nrecent_sep <- subset(recent_decade_monthly_mn, month==9)\nUT5_OP_conc_sep_wilcox <- wilcox.test(recent_sep$ConcDay, early_sep$ConcDay, exact=TRUE, conf.int = TRUE, conf.level = 0.9)\n\nearly_oct <- subset(early_decade_monthly_mn, month==10)\nrecent_oct <- subset(recent_decade_monthly_mn, month==10)\nUT5_OP_conc_oct_wilcox <- wilcox.test(recent_oct$ConcDay, early_oct$ConcDay, exact=TRUE, conf.int = TRUE, conf.level = 0.9)\n\nearly_nov <- subset(early_decade_monthly_mn, month==11)\nrecent_nov <- subset(recent_decade_monthly_mn, month==11)\nUT5_OP_conc_nov_wilcox <- wilcox.test(recent_nov$ConcDay, early_nov$ConcDay, exact=TRUE, conf.int = TRUE, conf.level = 0.9)\n\nearly_dec <- subset(early_decade_monthly_mn, month==12)\nrecent_dec <- subset(recent_decade_monthly_mn, month==12)\nUT5_OP_conc_dec_wilcox <- wilcox.test(recent_dec$ConcDay, early_dec$ConcDay, exact=TRUE, conf.int = TRUE, conf.level = 0.9)\n\nConc_compare <- data.frame(chng_est=c(UT5_OP_conc_oct_wilcox$est,\n                                      UT5_OP_conc_nov_wilcox$est,\n                                      UT5_OP_conc_dec_wilcox$est,\n                                      UT5_OP_conc_jan_wilcox$est,\n                                      UT5_OP_conc_feb_wilcox$est,\n                                      UT5_OP_conc_mar_wilcox$est,\n                                      UT5_OP_conc_apr_wilcox$est,\n                                      UT5_OP_conc_may_wilcox$est,\n                                      UT5_OP_conc_jun_wilcox$est,\n                                      UT5_OP_conc_jul_wilcox$est,\n                                      UT5_OP_conc_aug_wilcox$est,\n                                      UT5_OP_conc_sep_wilcox$est),\n                           low_conf=c(UT5_OP_conc_oct_wilcox$conf.int[1],\n                                      UT5_OP_conc_nov_wilcox$conf.int[1],\n                                      UT5_OP_conc_dec_wilcox$conf.int[1],\n                                      UT5_OP_conc_jan_wilcox$conf.int[1],\n                                      UT5_OP_conc_feb_wilcox$conf.int[1],\n                                      UT5_OP_conc_mar_wilcox$conf.int[1],\n                                      UT5_OP_conc_apr_wilcox$conf.int[1],\n                                      UT5_OP_conc_may_wilcox$conf.int[1],\n                                      UT5_OP_conc_jun_wilcox$conf.int[1],\n                                      UT5_OP_conc_jul_wilcox$conf.int[1],\n                                      UT5_OP_conc_aug_wilcox$conf.int[1],\n                                      UT5_OP_conc_sep_wilcox$conf.int[1]),\n                           up_conf=c(UT5_OP_conc_oct_wilcox$conf.int[2],\n                                     UT5_OP_conc_nov_wilcox$conf.int[2],\n                                     UT5_OP_conc_dec_wilcox$conf.int[2],\n                                     UT5_OP_conc_jan_wilcox$conf.int[2],\n                                     UT5_OP_conc_feb_wilcox$conf.int[2],\n                                     UT5_OP_conc_mar_wilcox$conf.int[2],\n                                     UT5_OP_conc_apr_wilcox$conf.int[2],\n                                     UT5_OP_conc_may_wilcox$conf.int[2],\n                                     UT5_OP_conc_jun_wilcox$conf.int[2],\n                                     UT5_OP_conc_jul_wilcox$conf.int[2],\n                                     UT5_OP_conc_aug_wilcox$conf.int[2],\n                                     UT5_OP_conc_sep_wilcox$conf.int[2]))\n\nwrite.table(Conc_compare, \"UT5_OP_conc_wilcox.txt\", quote=FALSE, row.names=FALSE)\n\nrng <- max(abs(c(Conc_compare$up_conf, Conc_compare$low_conf)))\ntiff(\"UT5_OP_conc_shift_wilcox_Vert_Bars.tif\", height=600, width=800, res=130)\npar(mar=c(4,5,0.5,0.5))\nplot(seq(1:12), Conc_compare$chng_est, typ='h', lend=1, lwd=15, col='white', xaxt='n', xlim=c(1,13), ylim=c(-rng, rng), xlab=\"Month\", ylab=expression(paste(\"Median Concentration Change, mg  \",L^-1,sep='')), las=1)\nplotCI(seq(1:12), Conc_compare$chng_est, ui=Conc_compare$up_conf, li=Conc_compare$low_conf, pch=16, add=TRUE)\nabline(h=0)\naxis(side=1,at=seq(1,12,by=1), labels=format(c(seq(as.Date(\"2000-10-01\"), as.Date(\"2000-12-01\"), by=\"month\"), seq(as.Date(\"2000-01-01\"), as.Date(\"2000-09-01\"), by=\"month\")),'%b'), las=2)\nlegend('topright', c(\"Median difference\", \"90% Confidence Interval for the Median\"), pch=c(16,NA), lwd=c(NA,1), pt.cex=c(1,NA), pt.bg=c('black',NA), bty='n', bg='white')\ndev.off()\n\n\n# Now do the load\n# ---------------\nearly_decade_monthly_flx <- aggregate(FluxDay ~ MonthSeq, data = early_decade, 'sum')\nrecent_decade_monthly_flx <- aggregate(FluxDay ~ MonthSeq, data = recent_decade, 'sum')\n\n# early_decade_monthly_mn$month <- format(seq(as.Date('1972-10-01'), as.Date('1982-09-30'), by='month'), '%b')\nearly_decade_monthly_flx$month <- rep(c(10:12,1:9), times=10)\nearly_decade_mon_mn_flx <- aggregate(FluxDay ~ month, data = early_decade_monthly_flx, 'mean')\nearly_decade_mon_sd_flx <- aggregate(FluxDay ~ month, data = early_decade_monthly_flx, 'sd')\nearly_decade_mon_mn_flx <- early_decade_mon_mn_flx[c(10:12,1:9),]\nearly_decade_mon_sd_flx <- early_decade_mon_sd_flx[c(10:12,1:9),]\n\nrecent_decade_monthly_flx$month <- rep(c(10:12,1:9), times=10)\nrecent_decade_mon_mn_flx <- aggregate(FluxDay ~ month, data = recent_decade_monthly_flx, 'mean')\nrecent_decade_mon_sd_flx <- aggregate(FluxDay ~ month, data = recent_decade_monthly_flx, 'sd')\nrecent_decade_mon_mn_flx <- recent_decade_mon_mn_flx[c(10:12,1:9),]\nrecent_decade_mon_sd_flx <- recent_decade_mon_sd_flx[c(10:12,1:9),]\n\nmdat3 <- matrix(c(early_decade_mon_mn_flx$FluxDay, recent_decade_mon_mn_flx$FluxDay),\n                nrow=2,ncol = 12, byrow=TRUE,\n                dimnames = list(c(\"1990-2000\", \"2001-2011\"),\n                                c(format(seq(as.Date('1973-10-01'), as.Date('1974-09-01'), by='month'), '%b'))))\n\nmx <- max(c((early_decade_mon_mn_flx$FluxDay + early_decade_mon_sd_flx$FluxDay), (recent_decade_mon_mn_flx$FluxDay + recent_decade_mon_sd_flx$FluxDay)))\ntiff(\"timing_shift_in_NO3_load_monthly_means.tif\", height=800, width=900, res=130)\nx <- barplot(mdat3, beside=TRUE, las=1, ylim=c(0,mx), col = c(\"lightblue\", \"mistyrose\"))\nabline(h=0)\narrows(x0=x[1,], y0=early_decade_mon_mn_flx$FluxDay - early_decade_mon_sd_flx$FluxDay, x1=x[1,], y1=early_decade_mon_mn_flx$FluxDay + early_decade_mon_sd_flx$FluxDay, angle=90, length=0.04, code=3)\narrows(x0=x[2,], y0=recent_decade_mon_mn_flx$FluxDay - recent_decade_mon_sd_flx$FluxDay, x1=x[2,], y1=recent_decade_mon_mn_flx$FluxDay + recent_decade_mon_sd_flx$FluxDay, angle=90, length=0.04, code=3)\nmtext(side=2, expression(paste(OP,', kg ',month^-1,sep='')), line=2.5)\nlegend(x=30, y=0.9 * mx, c(\"1990-2000\", \"2001-2011\"), pch=c(22,22), pt.cex=2, pt.bg=c(\"lightblue\", \"mistyrose\"), bty='n', xpd=TRUE)\ndev.off()\n\n# Apply Wilcox.text to the monthly loads here...\nearly_jan_flx <- subset(early_decade_monthly_flx, month==1)\nrecent_jan_flx <- subset(recent_decade_monthly_flx, month==1)\nUT5_OP_flux_jan_wilcox <- wilcox.test(recent_jan_flx$FluxDay, early_jan_flx$FluxDay, exact=TRUE, conf.int = TRUE, conf.level = 0.9)\n\nearly_feb_flx <- subset(early_decade_monthly_flx, month==2)\nrecent_feb_flx <- subset(recent_decade_monthly_flx, month==2)\nUT5_OP_flux_feb_wilcox <- wilcox.test(recent_feb_flx$FluxDay, early_feb_flx$FluxDay, exact=TRUE, conf.int = TRUE, conf.level = 0.9)\n\nearly_mar_flx <- subset(early_decade_monthly_flx, month==3)\nrecent_mar_flx <- subset(recent_decade_monthly_flx, month==3)\nUT5_OP_flux_mar_wilcox <- wilcox.test(recent_mar_flx$FluxDay, early_mar_flx$FluxDay, exact=TRUE, conf.int = TRUE, conf.level = 0.9)\n\nearly_apr_flx <- subset(early_decade_monthly_flx, month==4)\nrecent_apr_flx <- subset(recent_decade_monthly_flx, month==4)\nUT5_OP_flux_apr_wilcox <- wilcox.test(recent_apr_flx$FluxDay, early_apr_flx$FluxDay, exact=TRUE, conf.int = TRUE, conf.level = 0.9)\n\nearly_may_flx <- subset(early_decade_monthly_flx, month==5)\nrecent_may_flx <- subset(recent_decade_monthly_flx, month==5)\nUT5_OP_flux_may_wilcox <- wilcox.test(recent_may_flx$FluxDay, early_may_flx$FluxDay, exact=TRUE, conf.int = TRUE, conf.level = 0.9)\n\nearly_jun_flx <- subset(early_decade_monthly_flx, month==6)\nrecent_jun_flx <- subset(recent_decade_monthly_flx, month==6)\nUT5_OP_flux_jun_wilcox <- wilcox.test(recent_jun_flx$FluxDay, early_jun_flx$FluxDay, exact=TRUE, conf.int = TRUE, conf.level = 0.9)\n\nearly_jul_flx <- subset(early_decade_monthly_flx, month==7)\nrecent_jul_flx <- subset(recent_decade_monthly_flx, month==7)\nUT5_OP_flux_jul_wilcox <- wilcox.test(recent_jul_flx$FluxDay, early_jul_flx$FluxDay, exact=TRUE, conf.int = TRUE, conf.level = 0.9)\n\nearly_aug_flx <- subset(early_decade_monthly_flx, month==8)\nrecent_aug_flx <- subset(recent_decade_monthly_flx, month==8)\nUT5_OP_flux_aug_wilcox <- wilcox.test(recent_aug_flx$FluxDay, early_aug_flx$FluxDay, exact=TRUE, conf.int = TRUE, conf.level = 0.9)\n\nearly_sep_flx <- subset(early_decade_monthly_flx, month==9)\nrecent_sep_flx <- subset(recent_decade_monthly_flx, month==9)\nUT5_OP_flux_sep_wilcox <- wilcox.test(recent_sep_flx$FluxDay, early_sep_flx$FluxDay, exact=TRUE, conf.int = TRUE, conf.level = 0.9)\n\nearly_oct_flx <- subset(early_decade_monthly_flx, month==10)\nrecent_oct_flx <- subset(recent_decade_monthly_flx, month==10)\nUT5_OP_flux_oct_wilcox <- wilcox.test(recent_oct_flx$FluxDay, early_oct_flx$FluxDay, exact=TRUE, conf.int = TRUE, conf.level = 0.9)\n\nearly_nov_flx <- subset(early_decade_monthly_flx, month==11)\nrecent_nov_flx <- subset(recent_decade_monthly_flx, month==11)\nUT5_OP_flux_nov_wilcox <- wilcox.test(recent_nov_flx$FluxDay, early_nov_flx$FluxDay, exact=TRUE, conf.int = TRUE, conf.level = 0.9)\n\nearly_dec_flx <- subset(early_decade_monthly_flx, month==12)\nrecent_dec_flx <- subset(recent_decade_monthly_flx, month==12)\nUT5_OP_flux_dec_wilcox <- wilcox.test(recent_dec_flx$FluxDay, early_dec_flx$FluxDay, exact=TRUE, conf.int = TRUE, conf.level = 0.9)\n\n\nFlux_compare <- data.frame(chng_est=c(UT5_OP_flux_oct_wilcox$est,\n                                      UT5_OP_flux_nov_wilcox$est,\n                                      UT5_OP_flux_dec_wilcox$est,\n                                      UT5_OP_flux_jan_wilcox$est,\n                                      UT5_OP_flux_feb_wilcox$est,\n                                      UT5_OP_flux_mar_wilcox$est,\n                                      UT5_OP_flux_apr_wilcox$est,\n                                      UT5_OP_flux_may_wilcox$est,\n                                      UT5_OP_flux_jun_wilcox$est,\n                                      UT5_OP_flux_jul_wilcox$est,\n                                      UT5_OP_flux_aug_wilcox$est,\n                                      UT5_OP_flux_sep_wilcox$est),\n                           low_conf=c(UT5_OP_flux_oct_wilcox$conf.int[1],\n                                      UT5_OP_flux_nov_wilcox$conf.int[1],\n                                      UT5_OP_flux_dec_wilcox$conf.int[1],\n                                      UT5_OP_flux_jan_wilcox$conf.int[1],\n                                      UT5_OP_flux_feb_wilcox$conf.int[1],\n                                      UT5_OP_flux_mar_wilcox$conf.int[1],\n                                      UT5_OP_flux_apr_wilcox$conf.int[1],\n                                      UT5_OP_flux_may_wilcox$conf.int[1],\n                                      UT5_OP_flux_jun_wilcox$conf.int[1],\n                                      UT5_OP_flux_jul_wilcox$conf.int[1],\n                                      UT5_OP_flux_aug_wilcox$conf.int[1],\n                                      UT5_OP_flux_sep_wilcox$conf.int[1]),\n                           up_conf=c(UT5_OP_flux_oct_wilcox$conf.int[2],\n                                     UT5_OP_flux_nov_wilcox$conf.int[2],\n                                     UT5_OP_flux_dec_wilcox$conf.int[2],\n                                     UT5_OP_flux_jan_wilcox$conf.int[2],\n                                     UT5_OP_flux_feb_wilcox$conf.int[2],\n                                     UT5_OP_flux_mar_wilcox$conf.int[2],\n                                     UT5_OP_flux_apr_wilcox$conf.int[2],\n                                     UT5_OP_flux_may_wilcox$conf.int[2],\n                                     UT5_OP_flux_jun_wilcox$conf.int[2],\n                                     UT5_OP_flux_jul_wilcox$conf.int[2],\n                                     UT5_OP_flux_aug_wilcox$conf.int[2],\n                                     UT5_OP_flux_sep_wilcox$conf.int[2]))\n\nwrite.table(Flux_compare, \"UT5_OP_flux_wilcox.txt\", quote=FALSE, row.names=FALSE)\n\nrng_flx <- max(abs(c(Flux_compare$up_conf, Flux_compare$low_conf)))\ntiff(\"UT5_OP_flux_shift_wilcox_Vert_Bars.tif\", height=600, width=800, res=130)\npar(mar=c(4,5,0.5,0.5))\nplot(seq(1:12), Flux_compare$chng_est, typ='h', lend=1, lwd=15, col='white', xaxt='n', xlim=c(1,13), ylim=c(-rng_flx, rng_flx), xlab=\"Month\", ylab=expression(paste(\"Median Flux Change, kg\",sep='')), las=1)\nplotCI(seq(1:12), Flux_compare$chng_est, ui=Flux_compare$up_conf, li=Flux_compare$low_conf, pch=16, add=TRUE)\nabline(h=0)\naxis(side=1,at=seq(1,12,by=1), labels=format(c(seq(as.Date(\"2000-10-01\"), as.Date(\"2000-12-01\"), by=\"month\"), seq(as.Date(\"2000-01-01\"), as.Date(\"2000-09-01\"), by=\"month\")),'%b'), las=2)\nlegend('topright', c(\"Median difference\", \"90% Confidence Interval for the Median\"), pch=c(16,NA), lwd=c(NA,1), pt.cex=c(1,NA), pt.bg=c('black',NA), bty='n', bg='white')\ndev.off()\n\n#################  Using the plotConcQSmooth function\n###########\n#First do flow duration analysis\nflowDuration(eList, centerDate = \"06-01\", qUnit = 2, span = 30)\ndate1 <- \"1991-06-01\"\ndate2 <- \"2000-05-6-01\"\ndate3 <- \"2010-06-01\"\nqLow= baseQ\nqHigh=highQ7\n\ntiff(\"UT5_Date_Discharge_OP_conc_no_log.tif\",height = 700, width = 1000, res=120)\nplotConcQSmooth(eList,date1, date2, date3,qLow, qHigh, logScale=FALSE,printLegend =TRUE,legendLeft=0,legendTop=0,printTitle=TRUE)\ndev.off()\n\n# End of non-standard EGRET plot section requested by Michael\n# --------------------------------------------------------------------------------------------------------\n\n\n# Look for a trend change:\ntableChange(eList, fluxUnit=6, yearPoints=c(1990,1999,2011))\n#\n#UPPER TRUCKEE RV AT S UPPER TRUCKEE RD NR MEYERS \n#Phosphate\n#Water Year \n#\n#Concentration trends\n#time span       change     slope    change     slope\n#mg/L   mg/L/yr        %       %/yr\n#\n#1991  to  1996   7.3e-05   1.5e-05      0.66      0.13\n#1991  to  2001  -0.00046  -4.6e-05      -4.1     -0.41\n#1991  to  2006   0.00014   9.6e-06       1.3     0.086\n#1991  to  2011   0.00082   4.1e-05       7.4      0.37\n#1996  to  2001  -0.00053  -0.00011      -4.8     -0.95\n#1996  to  2006     7e-05     7e-06      0.63     0.063\n#1996  to  2011   0.00074     5e-05       6.7      0.44\n#2001  to  2006     6e-04   0.00012       5.7       1.1\n#2001  to  2011    0.0013   0.00013        12       1.2\n#2006  to  2011   0.00067   0.00013         6       1.2\n#\n#\n#Flux Trends\n#time span          change        slope       change        slope\n#10^3 tons/yr   10^3 tons/yr /yr      %         %/yr\n#1991  to  1996     -2.9e-05     -5.8e-06          -11         -2.2\n#1991  to  2001     -3.3e-05     -3.3e-06          -12         -1.2\n#1991  to  2006     -7.9e-06     -5.3e-07           -3         -0.2\n#1991  to  2011       -3e-06     -1.5e-07         -1.1       -0.056\n#1996  to  2001       -4e-06     -8.1e-07         -1.7        -0.34\n#1996  to  2006      2.1e-05      2.1e-06          8.8         0.88\n#1996  to  2011      2.6e-05      1.7e-06           11         0.72\n#2001  to  2006      2.5e-05        5e-06           11          2.1\n#2001  to  2011        3e-05        3e-06           13          1.3\n#2006  to  2011      4.9e-06      9.9e-07          1.9         0.38\n#\n#Generate out-of-the-box diagnostic plots\ntiff(\"fluxBiasMulti_UpperTruckee_Ortho_P.tif\", height = 1200, width = 1200, res=120)\n fluxBiasMulti(eList, moreTitle = \"WRTDS\")\ndev.off()\n\ntiff(\"Modeled_Daily_Conc_wObservations_UpperTruckee_UT5_Ortho_P.tif\", height = 800, width = 1000, res=120)\n plotConcTimeDaily(eList, concMax=0.06)\ndev.off()\n\n# Exploring model behavior and adjusting model parameters\ntiff(\"Contours_UpperTruckee_Ortho_P.tif\", height = 700, width = 1000, res=120)\n plotContours(eList,qBottom=0.03,qTop=10,yearStart=1990,yearEnd=2011, contourLevels=seq(0.003,0.03,by=0.0005), color.palette = colorRampPalette(c(\"violet\", \"purple\", \"blue\", \"cyan\", \"green\", \"yellow\", \"orange\", \"red\"))) \ndev.off()\n\ntiff(\"Log_Contours_UpperTruckee__UT5_Ortho_P.tif\", height = 700, width = 1000, res=120)\n plotContours(eList,qBottom=0.03, qTop=10, yearStart=1990, yearEnd=2011, contourLevels=seq(-5.75,-3.4,by=0.1), color.palette = colorRampPalette(c(\"violet\", \"purple\", \"blue\", \"cyan\", \"green\", \"yellow\", \"orange\", \"red\")), whatSurface=1) \ndev.off()\n\ntiff(\"StdErr_of_Log_Contours_UpperTruckee__UT5_Ortho_P.tif\", height = 700, width = 1000, res=120)\n plotContours(eList, qBottom=0.03, qTop=10, yearStart=1990, yearEnd=2011, contourLevels=seq(0.13,0.5,by=0.01), color.palette = colorRampPalette(c(\"violet\", \"purple\", \"blue\", \"cyan\", \"green\", \"yellow\", \"orange\", \"red\")), whatSurface=2) \ndev.off()\n\ntiff(\"Contours_Difference_Ortho_P_UPperTruckee_UT5.tif\", height = 700, width = 1000, res=120)\n plotDiffContours(eList, 1990,2011,0.03,10,maxDiff=0.01)\ndev.off()\n\ntiff(\"Contours_PercentDifference_Ortho_P_UPperTruckee_UT5.tif\", height = 700, width = 1000, res=120)\n plotDiffContours(eList, 1990,2011,0.03,10,maxDiff=100, plotPercent=TRUE)\ndev.off()\n\ntiff(\"Contours_PercentDifference2_Ortho_P_UpperTruckee_UT5.tif\", height = 700, width = 1000, res=120)\n plotDiffContours2(eList, 1990,2011,0.05,10, maxDiff=c(-100,100), plotPercent=TRUE, lwd=3, color.palette=colorRampPalette(c(\"blue\",\"lightblue\",\"white\",\"orange\",\"red\")),tick.lwd = 1)\ndev.off()\n\n# ---------------------------\n# Now run the EGRETci package\n# ---------------------------\n\n# Change working directory\nsetwd(\"..\")\nsubDir <- 'EGRETci_plots'\nif (file.exists(subDir)){\n    setwd(file.path(getwd(),subDir))\n} else {\n    dir.create(file.path(getwd(),subDir), recursive=TRUE)\n    setwd(file.path(getwd(),subDir))\n}\n\n#Interactive function to set up trend analysis:\ncaseSetUp <- trendSetUp(eList, \n                        year1=1991, \n                        year2=2011, \n                        nBoot = 200, \n                        bootBreak = 100, \n                        blockLength = 200)\neBoot <- wBT(eList, caseSetUp, fileName =\"outputText.txt\")\n\n#Should we reject Ho that Flow Normalized Concentration Trend = 0 ? Do Not Reject Ho\n#best estimate is 0.000817 mg/L\n#Lower and Upper 90% CIs -0.000765  0.002487\n#also 95% CIs-0.001026  0.002984\n#and 50% CIs  0.000278  0.001452\n#approximate two-sided p-value for Conc      0.35\n#Likelihood that Flow Normalized Concentration is trending up =      0.827 is trending down =      0.173\n#\n#Should we reject Ho that Flow Normalized Flux Trend = 0 ? Do Not Reject Ho\n#best estimate is -2.708e-06 10^6 kg/year\n#Lower and Upper 90% CIs -3.98e-05  3.22e-05\n#also 95% CIs -6.82e-05  3.35e-05\n#and 50% CIs -1.70e-05  1.69e-05\n#approximate two-sided p-value for Flux      0.96\n#Likelihood that Flow Normalized Flux is trending up = 0.52 is trending down= 0.48\n#\n#Upward trend in concentration is likely\n#Upward trend in flux is about as likely as not\n#Downward trend in concentration is unlikely\n#Downward trend in flux is about as likely as not\n#\n \nsaveEGRETci(eList, eBoot, caseSetUp, fileName = \"EGRETci_output_Ortho_P\")\n\nplotHistogramTrend2 <-\nfunction (eBoot, caseSetUp, eList, xSeq = seq(-100, 100, 10), \n    flux = TRUE, printTitle = TRUE, cex.main = 1.1, col.fill = \"grey\", xlim = c(-100,100),\n    ...) \n{\n    bootOut <- eBoot$bootOut\n    INFO <- eList$INFO\n    if (flux) {\n        xFlux <- eBoot$xFlux\n        change <- 100 * bootOut$estF/bootOut$baseFlux\n        reps <- 100 * xFlux/bootOut$baseFlux\n        xlabel <- \"Flux trend, in %\"\n        titleWord <- \"Flux\"\n    }\n    else {\n        xConc <- eBoot$xConc\n        change <- 100 * bootOut$estC/bootOut$baseConc\n        reps <- 100 * xConc/bootOut$baseConc\n        xlabel <- \"Concentration trend, in %\"\n        titleWord <- \"Concentration\"\n    }\n    titleToPrint <- ifelse(printTitle, paste(\"Histogram of trend in\", \n        INFO$paramShortName, \"\\n\", titleWord, \"Normalized Concentration:\", \n        caseSetUp$year1, \"to\", caseSetUp$year2, \"\\n\", INFO$shortName), \n        \"\")\n    hist(reps, breaks = xSeq, yaxs = \"i\", xaxs = \"i\", tcl = 0.5, \n        main = titleToPrint, freq = FALSE, xlab = xlabel, col = col.fill, \n        cex.main = cex.main, xlim=xlim, ...)\n    abline(v = change, lwd = 3, lty = 2)\n    abline(v = 0, lwd = 3)\n    box()\n    axis(3, tcl = 0.5, labels = FALSE)\n    axis(4, tcl = 0.5, labels = FALSE)\n}\n\ntiff(\"histo_NO3_UpTruck_Trend_conc_flux.tif\", height = 700, width = 1200, res=120)\n par(mfrow=c(1,2))\n plotHistogramTrend2(eBoot, caseSetUp, eList, flux=FALSE, xSeq = seq(-8000,8000,5),las=1,xlim=c(-100,100))\n abline(h=0)\n \n plotHistogramTrend2(eBoot, caseSetUp, eList, flux=TRUE, xSeq = seq(-50000,50000,5),las=1)\n abline(h=0)\ndev.off()\n\nnBoot <- 200\nblockLength <- 200\ncoreOut <- 5 #Number of cores to leave out of processing tasks\n\nwidthCI <- 95\nciLower <- (50-(widthCI/2))/100\nciUpper <- (50+(widthCI/2))/100\nprobs <- c(ciLower,ciUpper)\n\nnCores <- detectCores() - coreOut\ncl <- makeCluster(nCores)\nregisterDoParallel(cl)\nrepAnnual <- foreach(n = 1:nBoot,.packages=c('EGRETci')) %dopar% {\n   annualResults <- bootAnnual(eList, blockLength)  \n}\nstopCluster(cl)\n\nCIAnnualResults <- ciBands(eList, repAnnual, probs)\nconc.poly.x <- c(CIAnnualResults$Year,rev(CIAnnualResults$Year))\nconc.poly.y <- c(CIAnnualResults$FNConcLow,rev(CIAnnualResults$FNConcHigh))\nflux.poly.x <- c(CIAnnualResults$Year,rev(CIAnnualResults$Year))\nflux.poly.y <- c(CIAnnualResults$FNFluxLow*365,rev(CIAnnualResults$FNFluxHigh*365))\n\ntiff(\"Ann_Avg_Conc_&_Ann_Flow_Normalized_Conc_Boot_UpperTruckee_UT5_OP.tif\", height = 500, width = 600, res=110)\n plotConcHistBoot(eList, CIAnnualResults, plotFlowNorm=TRUE, showYLabels=TRUE, showYAxis=TRUE,col=4)\n polygon(x=conc.poly.x, y=conc.poly.y, col=rgb(24,116,205,40,max=255),border=NA)\ndev.off()\n\ntiff(\"Ann_Flux_&_Ann_Flow_Normalized_Flux_Boot_UpperTruckee_UT5_OP.tif\", height = 500, width = 600, res=110)\n plotFluxHistBoot(eList, fluxUnit=13, CIAnnualResults, showYLabels=TRUE, showYAxis=TRUE, col=4)\n polygon(x=flux.poly.x, y=flux.poly.y, col=rgb(24,116,205,40,max=255),border=NA)\ndev.off()\n\nsetSweave(\"UT5_OP_Conc_UpperTUT5_EGRETCI\",7,7)\nplotConcHistBoot(eList, CIAnnualResults, plotFlowNorm=TRUE, showYLabels=TRUE, showYAxis=TRUE,col=4)\npolygon(x=conc.poly.x, y=conc.poly.y, col=rgb(24,116,205,40,max=255),border=NA)\ngraphics.off()\n\nsetSweave(\"UT5_OP_Flux_UpperTUT5_EGRETCI\",7,7)\nplotFluxHistBoot(eList, fluxUnit=13, CIAnnualResults, showYLabels=TRUE, showYAxis=TRUE, col=4)\npolygon(x=flux.poly.x, y=flux.poly.y, col=rgb(24,116,205,40,max=255),border=NA)\ngraphics.off()\n\nsaveEGRETci(eList, eBoot, fileName=\"N_Boot_Ortho_P\")\nsave(repAnnual,file=\"RepAnnual\")\n\n# load(file=\"N_Boot.RData\")\n# load(file=\"RepAnnual\")\n\n\n#############################################################\n# Working on TKN\n#############################################################\nstartDate <- \"1990-06-01\"\nendDate <- \"2011-09-30\"\nsiteNumber <- \"10336580\"\nQParameterCd <- \"00060\"\nparameterCd <- \"00625\"  # \"TN\"\nfileName <- \"UT5_TKN.csv\"\nDaily <- readNWISDaily(siteNumber, QParameterCd, startDate, endDate)\nSample <- readUserSample(filePath, fileName)\n#Sample <- readNWISSample(siteNumber, parameterCd, startDate, endDate)\nINFO <- readNWISInfo(siteNumber = siteNumber, parameterCd = parameterCd, interactive=FALSE)\nINFO$staAbbrev <- paste(strsplit(INFO$station_nm,\" \")[[1]][1],strsplit(INFO$station_nm,\" \")[[1]][2])\n\n# Have a look at the available range of NO3 data\nrange(Sample$Date)\n#  \"1990-06-07\" \"2011-09-06\"\n\neList <- mergeReport(INFO, Daily, Sample)\nplotConcTime(eList)\n# Change the working directory; redirect plot output to TKN folder\nsetwd(\"../..\")\nsubDir <- 'TKN/EGRET_plots'\nif (file.exists(subDir)){\n    setwd(file.path(getwd(),subDir))\n} else {\n    dir.create(file.path(getwd(),subDir), recursive=TRUE)\n    setwd(file.path(getwd(),subDir))\n}\n\n# Plot water quality data\ntiff(\"Conc_vs_Time_Upper_Truckee_SupTruckUT5_TN.tif\", height = 600, width = 800, res=120)\n  plotConcTime(eList)\ndev.off()\n\n# Now, a classic Q-C plot\ntiff(\"Conc-Q_UpperTruckee_SupTruckUT5_TN.tif\", height = 600, width = 800, res=120)\n  plotConcQ(eList, logScale=TRUE)\ndev.off()\n\n# The data set as flux values rather than as concentrations\ntiff(\"Flux-Q_UpperTruckee_SupTruckUT5_TN.tif\", height = 600, width = 800, res=120)\n  plotFluxQ(eList, fluxUnit=4)\ndev.off()\n\n# Monthly boxplots\ntiff(\"Monthly-Conc_BoxPlots_UpperTruckee_SupTruckUT5_TN.tif\", height = 600, width = 800, res=120)\n  boxConcMonth(eList, logScale=TRUE, concMax=2)\ndev.off()\n\n# Flow on days sampled vs. all other days\ntiff(\"Flow_on_days_sampled_vs_all_other_days_UpperTruckee_SupTruckUT5_TN.tif\", height = 600, width = 800, res=120)\n  boxQTwice(eList, qUnit=1)\ndev.off()\n\n#########################################\n# Now start the Flow-Normalized Analysis\n#########################################\n\n# Build the regression model\neList <- modelEstimation(eList, windowY = 7, windowQ = 2, windowS = 0.5, minNumObs = 100, minNumUncen =50)\n\nMonthlyResults <- calculateMonthlyResults(eList)\n\n# Plot the annual average concentration and annual flow-normalized concentration\ntiff(\"Ann_Avg_Conc_&_Ann_Flow_Normalized_Conc_UPperTruckee_SupTruckUT5_TN.tif\", height = 600, width = 800, res=120)\n  plotConcHist(eList, plotFlowNorm=TRUE)\ndev.off()\n\n# Plot the annual flux and annual flow-normalized flux\ntiff(\"Ann_Flux_&_Ann_Flow_Normalized_FluxUPperTruckee_SupTruckUT5_TN.tif\", height = 600, width = 800, res=120)\n  plotFluxHist(eList, plotFlowNorm = TRUE) # fluxMax) # fluxMax\ndev.off()\n\n# Look for a trend change:\ntableChange(eList, fluxUnit=6, yearPoints=c(1990, 1997, 2005,2011))\n\n#UPPER TRUCKEE RV AT S UPPER TRUCKEE RD NR MEYERS \n#Kjeldahl nitrogen\n#Water Year \n#\n#Concentration trends\n#time span       change     slope    change     slope\n#mg/L   mg/L/yr        %       %/yr\n#\n#1991  to  1996    -0.053    -0.011       -34      -6.8\n#1991  to  2001    -0.052   -0.0052       -33      -3.3\n#1991  to  2006     -0.05   -0.0033       -32      -2.1\n#1991  to  2011    -0.065   -0.0033       -41      -2.1\n#1996  to  2001   0.00076   0.00015      0.72      0.14\n#1996  to  2006    0.0035   0.00035       3.4      0.34\n#1996  to  2011    -0.012  -0.00081       -12     -0.77\n#2001  to  2006    0.0028   0.00055       2.6      0.53\n#2001  to  2011    -0.013   -0.0013       -12      -1.2\n#2006  to  2011    -0.016   -0.0031       -14      -2.9\n#\n#\n#Flux Trends\n#time span          change        slope       change        slope\n#10^3 tons/yr   10^3 tons/yr /yr      %         %/yr\n#1991  to  1996      -0.0033     -0.00066          -43         -8.5\n#1991  to  2001      -0.0032     -0.00032          -42         -4.2\n#1991  to  2006      -0.0028     -0.00018          -36         -2.4\n#1991  to  2011      -0.0034     -0.00017          -44         -2.2\n#1996  to  2001      7.9e-05      1.6e-05          1.8         0.36\n#1996  to  2006      0.00053      5.3e-05           12          1.2\n#1996  to  2011     -0.00011     -7.4e-06         -2.5        -0.17\n#2001  to  2006      0.00045      9.1e-05           10            2\n#2001  to  2011     -0.00019     -1.9e-05         -4.2        -0.42\n#2006  to  2011     -0.00064     -0.00013          -13         -2.6\n \n#Generate out-of-the-box diagnostic plots\ntiff(\"fluxBiasMulti_UpperTruckee_SupTruckUT5_TN.tif\", height = 1200, width = 1200, res=120)\n fluxBiasMulti(eList, moreTitle = \"WRTDS\")\ndev.off()\n\ntiff(\"Modeled_Daily_Conc_wObservations_UpperTruckee_SupTruckUT5_TN.tif\", height = 800, width = 1000, res=120)\n plotConcTimeDaily(eList)\ndev.off()\n\n# Exploring model behavior and adjusting model parameters\ntiff(\"Contours_UpperTruckee_SupTruckUT5_TN.tif\", height = 700, width = 1000, res=120)\n plotContours(eList, qBottom=0.03,qTop=10,yearStart=1990,yearEnd=2011, contourLevels=seq(0.01,0.5,by=0.01), color.palette = colorRampPalette(c(\"violet\", \"purple\", \"blue\", \"cyan\", \"green\", \"yellow\", \"orange\", \"red\"))) \ndev.off()\n\ntiff(\"Log_Contours_UpperTruckee_SupTruckUT5_TN.tif\", height = 700, width = 1000, res=120)\n plotContours(eList, qBottom=0.03, qTop=10, yearStart=1990, yearEnd=2011, contourLevels=seq(-4.1,-0.45,by=0.1), color.palette = colorRampPalette(c(\"violet\", \"purple\", \"blue\", \"cyan\", \"green\", \"yellow\", \"orange\", \"red\")), whatSurface=1) \ndev.off()\n\ntiff(\"StdErr_of_Log_Contours_UpperTruckee_SupTruckUT5_TN.tif\", height = 700, width = 1000, res=120)\n plotContours(eList, qBottom=0.03, qTop=10, yearStart=1990, yearEnd=2011, contourLevels=seq(0.32,0.61,by=0.005), color.palette = colorRampPalette(c(\"violet\", \"purple\", \"blue\", \"cyan\", \"green\", \"yellow\", \"orange\", \"red\")), whatSurface=2) \ndev.off()\n\ntiff(\"Contours_Difference_SupTruckUT5_TN.tif\", height = 700, width = 1000, res=120)\n plotDiffContours(eList, 1990,2011,0.03,10,maxDiff=0.2)\ndev.off()\n\ntiff(\"Contours_PercentDifference_SupTruckUT5_TN.tif\", height = 700, width = 1000, res=120)\n plotDiffContours(eList, 1990,2011,0.03,10, maxDiff=100, plotPercent=TRUE)\ndev.off()\n\ntiff(\"Contours_PercentDifference2_SupTruckUT5_TN.tif\", height = 700, width = 1000, res=120)\n plotDiffContours2(eList, 1990,2011,0.03,10, maxDiff=c(-100,100), plotPercent=TRUE, lwd=3, color.palette=colorRampPalette(c(\"blue\",\"lightblue\",\"white\",\"orange\",\"red\")),tick.lwd = 1)\ndev.off()\n\nSample$WY <- trunc(Sample$DecYear+0.25) \ntiff(\"Monthly_Boxplot_SupTruckUT5_TN.tif\", height = 700, width = 1000, res=120)\n par(mar=c(4,6,0.5,0.5))\n boxplot(Sample$ConcAve~Sample$WY,log=\"y\",varwidth=TRUE,ylim=c(0.01,2),yaxs=\"i\",xlab=\"Water Year\",las=1) \n mtext(side=2, expression(paste(\"Concentration, Inorganic Nitrogen, in mg  \",L^-1,sep=\"\")),line=4)\ndev.off()\n\n# ---------------------------\n# Now run the EGRETci package\n# ---------------------------\n\n# Change working directory\nsetwd(\"..\")\nsubDir <- 'EGRETci_plots'\nif (file.exists(subDir)){\n    setwd(file.path(getwd(),subDir))\n} else {\n    dir.create(file.path(getwd(),subDir), recursive=TRUE)\n    setwd(file.path(getwd(),subDir))\n}\n\n#Interactive function to set up trend analysis:\ncaseSetUp <- trendSetUp(eList, \n                        year1=1991, \n                        year2=2011, \n                        nBoot = 200, \n                        bootBreak = 100, \n                        blockLength = 200)\neBoot <- wBT(eList, caseSetUp, fileName =\"outputText.txt\")\n\n#Should we reject Ho that Flow Normalized Concentration Trend = 0 ? Reject Ho\n#best estimate is -0.0654 mg/L\n#Lower and Upper 90% CIs  -0.0959  -0.0316\n#also 95% CIs -0.1081   0.7874\n#and 50% CIs  -0.0834  -0.0532\n#approximate two-sided p-value for Conc     0.059\n#Likelihood that Flow Normalized Concentration is trending up =     0.0248 is trending down =      0.975\n#\n#Should we reject Ho that Flow Normalized Flux Trend = 0 ? Do Not Reject Ho\n#best estimate is -0.003084 10^6 kg/year\n#Lower and Upper 90% CIs -0.006083  0.005618\n#also 95% CIs -0.013042  0.485416\n#and 50% CIs -0.004486 -0.002421\n#approximate two-sided p-value for Flux      0.16\n#Likelihood that Flow Normalized Flux is trending up = 0.0842 is trending down= 0.916\n#\n#Upward trend in concentration is highly unlikely\n#Upward trend in flux is very unlikely\n#Downward trend in concentration is highly likely\n#Downward trend in flux is very likely\n#\n\n# \nsaveEGRETci(eList, eBoot, caseSetUp, fileName = \"EGRETci_output_TN\")\n\nplotHistogramTrend2 <-\nfunction (eBoot, caseSetUp, eList, xSeq = seq(-100, 100, 10), \n    flux = TRUE, printTitle = TRUE, cex.main = 1.1, col.fill = \"grey\", xlim = c(-100,100),\n    ...) \n{\n    bootOut <- eBoot$bootOut\n    INFO <- eList$INFO\n    if (flux) {\n        xFlux <- eBoot$xFlux\n        change <- 100 * bootOut$estF/bootOut$baseFlux\n        reps <- 100 * xFlux/bootOut$baseFlux\n        xlabel <- \"Flux trend, in %\"\n        titleWord <- \"Flux\"\n    }\n    else {\n        xConc <- eBoot$xConc\n        change <- 100 * bootOut$estC/bootOut$baseConc\n        reps <- 100 * xConc/bootOut$baseConc\n        xlabel <- \"Concentration trend, in %\"\n        titleWord <- \"Concentration\"\n    }\n    titleToPrint <- ifelse(printTitle, paste(\"Histogram of trend in\", \n        INFO$paramShortName, \"\\n\", titleWord, \"Normalized Concentration:\", \n        caseSetUp$year1, \"to\", caseSetUp$year2, \"\\n\", INFO$shortName), \n        \"\")\n    hist(reps, breaks = xSeq, yaxs = \"i\", xaxs = \"i\", tcl = 0.5, \n        main = titleToPrint, freq = FALSE, xlab = xlabel, col = col.fill, \n        cex.main = cex.main, xlim=xlim, ...)\n    abline(v = change, lwd = 3, lty = 2)\n    abline(v = 0, lwd = 3)\n    box()\n    axis(3, tcl = 0.5, labels = FALSE)\n    axis(4, tcl = 0.5, labels = FALSE)\n}\n\ntiff(\"histo_NO3_UpTruck_S_UpTruck_Trend_conc_flux.tif\", height = 700, width = 1200, res=120)\n par(mfrow=c(1,2))\n plotHistogramTrend2(eBoot, caseSetUp, eList, flux=FALSE, xSeq = seq(-8000,8000,5),las=1,xlim=c(-100,100))\n abline(h=0)\n \n plotHistogramTrend2(eBoot, caseSetUp, eList, flux=TRUE, xSeq = seq(-50000,50000,5),las=1)\n abline(h=0)\ndev.off()\n\nnBoot <- 200\nblockLength <- 200\ncoreOut <- 5 #Number of cores to leave out of processing tasks\n\nwidthCI <- 95\nciLower <- (50-(widthCI/2))/100\nciUpper <- (50+(widthCI/2))/100\nprobs <- c(ciLower,ciUpper)\n\nnCores <- detectCores() - coreOut\ncl <- makeCluster(nCores)\nregisterDoParallel(cl)\nrepAnnual <- foreach(n = 1:nBoot,.packages=c('EGRETci')) %dopar% {\n   annualResults <- bootAnnual(eList, blockLength)  \n}\nstopCluster(cl)\n\nCIAnnualResults <- ciBands(eList, repAnnual, probs)\nconc.poly.x <- c(CIAnnualResults$Year,rev(CIAnnualResults$Year))\nconc.poly.y <- c(CIAnnualResults$FNConcLow,rev(CIAnnualResults$FNConcHigh))\nflux.poly.x <- c(CIAnnualResults$Year,rev(CIAnnualResults$Year))\nflux.poly.y <- c(CIAnnualResults$FNFluxLow*365,rev(CIAnnualResults$FNFluxHigh*365))\n\ntiff(\"Ann_Avg_Conc_&_Ann_Flow_Normalized_Conc_Boot_UpperTruckee_SupTruckUT5_TN.tif\", height = 500, width = 600, res=110)\n plotConcHistBoot(eList, CIAnnualResults, plotFlowNorm=TRUE, showYLabels=TRUE, showYAxis=TRUE,col=4)\n polygon(x=conc.poly.x, y=conc.poly.y, col=rgb(24,116,205,40,max=255),border=NA)\ndev.off()\n\ntiff(\"Ann_Flux_&_Ann_Flow_Normalized_Flux_Boot_UpperTruckee_SupTruckUT5_TN.tif\", height = 500, width = 600, res=110)\n plotFluxHistBoot(eList, fluxUnit=13, CIAnnualResults, showYLabels=TRUE, showYAxis=TRUE, col=4)\n polygon(x=flux.poly.x, y=flux.poly.y, col=rgb(24,116,205,40,max=255),border=NA)\ndev.off()\n\nsetSweave(\"UT5_TKN_Conc_EGRETCI\",7,7)\nplotConcHistBoot(eList, CIAnnualResults, plotFlowNorm=TRUE, showYLabels=TRUE, showYAxis=TRUE,col=4)\npolygon(x=conc.poly.x, y=conc.poly.y, col=rgb(24,116,205,40,max=255),border=NA)\ngraphics.off()\n\nsetSweave(\"UT5_TKN_Flux_EGRETCI\",7,7)\nplotFluxHistBoot(eList, fluxUnit=13, CIAnnualResults, showYLabels=TRUE, showYAxis=TRUE, col=4)\npolygon(x=flux.poly.x, y=flux.poly.y, col=rgb(24,116,205,40,max=255),border=NA)\ndev.off()\ngraphics.off()\n\n\nsaveEGRETci(eList, eBoot, fileName=\"TN_Boot_UpTruck_at_South_UpTruck.RData\")\nsave(repAnnual,file=\"RepAnnual\")\n\n# load(file=\"TN_Boot_UpTruck_at_South_UpTruck.RData\")\n# load(file=\"RepAnnual\")\n\n\n#############################################################\n# Working on TP\n#############################################################\nstartDate <- \"1990-06-01\"\nendDate <- \"2011-09-30\"\nsiteNumber <- \"10336580\"\nQParameterCd <- \"00060\"\nparameterCd <- \"00665\"  # \"TP\"\nfileName <- \"UT5_TP.csv\"\nDaily <- readNWISDaily(siteNumber, QParameterCd, startDate, endDate)\nSample <- readUserSample(filePath, fileName)\n\n#Sample <- readNWISSample(siteNumber, parameterCd, startDate, endDate)\nINFO <- readNWISInfo(siteNumber = siteNumber, parameterCd = parameterCd, interactive=FALSE)\nINFO$staAbbrev <- paste(strsplit(INFO$station_nm,\" \")[[1]][1],strsplit(INFO$station_nm,\" \")[[1]][2])\n\n# Have a look at the available range of TP data\nrange(Sample$Date)\n#\"1990-06-07\" \"2011-09-06\"\neList <- mergeReport(INFO, Daily, Sample)\n\n# Change the working directory; redirect plot output to TP folder\nsetwd(\"../..\")\nsubDir <- 'TP/EGRET_plots'\nif (file.exists(subDir)){\n    setwd(file.path(getwd(),subDir))\n} else {\n    dir.create(file.path(getwd(),subDir), recursive=TRUE)\n    setwd(file.path(getwd(),subDir))\n}\n\n# Plot water quality data\ntiff(\"Conc_vs_Time_UpperTruckee_SupTruckUT5_TP.tif\", height = 600, width = 800, res=120)\n  plotConcTime(eList, concMax=0.3)\ndev.off()\n\n# Now, a classic Q-C plot\ntiff(\"Conc-Q_UpperTruckee_SupTruckUT5_TP.tif\", height = 600, width = 800, res=120)\n  plotConcQ(eList, logScale=TRUE,concMax=1)\ndev.off()\n\n# The data set as flux values rather than as concentrations\ntiff(\"Flux-Q_UpperTruckee_SupTruckUT5_TP.tif\", height = 600, width = 800, res=120)\n  plotFluxQ(eList, fluxUnit=4,fluxMax=2)\ndev.off()\n\n# Monthly boxplots\ntiff(\"Monthly-Conc_BoxPlots_UpperTruckee_SupTruckUT5_TP.tif\", height = 600, width = 800, res=120)\n  boxConcMonth(eList, logScale=TRUE, concMax=2)\ndev.off()\n\n# Flow on days sampled vs. all other days\ntiff(\"Flow_on_days_sampled_vs_all_other_days_UpperTruckee_SupTruckUT5_TP.tif\", height = 600, width = 800, res=120)\n  boxQTwice(eList, qUnit=1)\ndev.off()\n\n#########################################\n# Now start the Flow-Normalized Analysis\n#########################################\n\n# Build the regression model\neList <- modelEstimation(eList, windowY = 7, windowQ = 2, windowS = 0.5, minNumObs = 100, minNumUncen =50)\n\nMonthlyResults <- calculateMonthlyResults(eList)\n\n# Plot the annual average concentration and annual flow-normalized concentration\ntiff(\"Ann_Avg_Conc_&_Ann_Flow_Normalized_Conc_UpperTruckee_SupTruckUT5_TP.tif\", height = 600, width = 800, res=120)\n  plotConcHist(eList, plotFlowNorm=TRUE)\ndev.off()\n\n# Plot the annual flux and annual flow-normalized flux\ntiff(\"Ann_Flux_&_Ann_Flow_Normalized_Flux_UpperTruckee_SupTruckUT5_TP.tif\", height = 600, width = 800, res=120)\n  plotFluxHist(eList, plotFlowNorm = TRUE) # fluxMax) # fluxMax\ndev.off()\n\n# Look for a trend change:\ntableChange(eList, fluxUnit=6, yearPoints=c(1990,1998,2001,2011))\n\n#UPPER TRUCKEE RV AT S UPPER TRUCKEE RD NR MEYERS \n#Phosphorus\n#Water Year \n#\n#Concentration trends\n#time span       change     slope    change     slope\n#mg/L   mg/L/yr        %       %/yr\n#\n#1991  to  1996   -0.0062   -0.0012       -19      -3.8\n#1991  to  2001   -0.0091  -0.00091       -28      -2.8\n#1991  to  2006   -0.0062  -0.00041       -19      -1.3\n#1991  to  2011   -0.0039    -2e-04       -12      -0.6\n#1996  to  2001   -0.0029  -0.00058       -11      -2.2\n#1996  to  2006   2.1e-05   2.1e-06      0.08     0.008\n#1996  to  2011    0.0023   0.00015       8.5      0.57\n#2001  to  2006    0.0029   0.00059        12       2.5\n#2001  to  2011    0.0052   0.00052        22       2.2\n#2006  to  2011    0.0023   0.00045       8.5       1.7\n#\n#\n#Flux Trends\n#time span          change        slope       change        slope\n#10^3 tons/yr   10^3 tons/yr /yr      %         %/yr\n#1991  to  1996     -0.00046     -9.3e-05          -32         -6.4\n#1991  to  2001       -5e-04       -5e-05          -34         -3.4\n#1991  to  2006     -0.00044       -3e-05          -30           -2\n#1991  to  2011     -0.00034     -1.7e-05          -23         -1.2\n#1996  to  2001     -3.4e-05     -6.9e-06         -3.4        -0.69\n#1996  to  2006      2.2e-05      2.2e-06          2.2         0.22\n#1996  to  2011      0.00012      8.1e-06           12         0.82\n#2001  to  2006      5.6e-05      1.1e-05          5.9          1.2\n#2001  to  2011      0.00016      1.6e-05           16          1.6\n#2006  to  2011        1e-04        2e-05          9.8            2\n#\n#Generate out-of-the-box diagnostic plots\ntiff(\"fluxBiasMulti_UpperTruckee_SupTruckUT5_TP.tif\", height = 1200, width = 1000, res=120)\n fluxBiasMulti(eList, moreTitle = \"WRTDS\")\ndev.off()\n\ntiff(\"Modeled_Daily_Conc_wObservations_UpperTruckee_SupTruckUT5_TP.tif\", height = 800, width = 1000, res=120)\n plotConcTimeDaily(eList)\ndev.off()\n\n# Exploring model behavior and adjusting model parameters\ntiff(\"Contours_UpperTruckee_SupTruckUT5_TP.tif\", height = 700, width = 1000, res=120)\n plotContours(eList, qBottom=0.03,qTop=10,yearStart=1990,yearEnd=2011, contourLevels=seq(0.01,0.08,by=0.001), color.palette = colorRampPalette(c(\"violet\", \"purple\", \"blue\", \"cyan\", \"green\", \"yellow\", \"orange\", \"red\"))) \ndev.off()\n\ntiff(\"Log_Contours_UpperTruckee_SupTruckUT5_TP.tif\", height = 700, width = 1000, res=120)\n plotContours(eList, qBottom=0.03, qTop=10, yearStart=1990, yearEnd=2011, contourLevels=seq(-4.380,-2.7,by=0.1), color.palette = colorRampPalette(c(\"violet\", \"purple\", \"blue\", \"cyan\", \"green\", \"yellow\", \"orange\", \"red\")), whatSurface=1) \ndev.off()\n\ntiff(\"StdErr_of_Log_Contours_UpperTruckee_SupTruckUT5_TP.tif\", height = 700, width = 1000, res=120)\n plotContours(eList, qBottom=0.03, qTop=10, yearStart=1990, yearEnd=2011, contourLevels=seq(0.16,0.45,by=0.01), color.palette = colorRampPalette(c(\"violet\", \"purple\", \"blue\", \"cyan\", \"green\", \"yellow\", \"orange\", \"red\")), whatSurface=2) \ndev.off()\n\ntiff(\"Contours_Difference_TP_UpperTruckee_SupTruckUT5.tif\", height = 700, width = 1000, res=120)\n plotDiffContours(eList, 1990,2011,0.03,10,maxDiff=0.05)\ndev.off()\n\ntiff(\"Contours_PercentDifference_TP_UPperTruckee_SupTruckUT5.tif\", height = 700, width = 1000, res=120)\n plotDiffContours(eList, 1990,2011,0.03,10, maxDiff=100, plotPercent=TRUE)\ndev.off()\n\ntiff(\"Contours_PercentDifference2_TP_UpperTruckee_SupTruckUT5.tif\", height = 700, width = 1000, res=120)\n plotDiffContours2(eList, 1990,2011,0.05,10, maxDiff=c(-100,100), plotPercent=TRUE, lwd=3, color.palette=colorRampPalette(c(\"purple\",\"blue\",\"lightblue\",\"white\",\"yellow\", \"orange\", \"red\")),tick.lwd = 1)\ndev.off()\n\nSample$WY <- trunc(Sample$DecYear+0.25) \ntiff(\"Monthly_Boxplot_Inorg_SupTruckUT5_TP.tif\", height = 700, width = 1000, res=120)\n par(mar=c(4,6,0.5,0.5))\n boxplot(Sample$ConcAve~Sample$WY,log=\"y\",varwidth=TRUE,ylim=c(0.01,2),yaxs=\"i\",xlab=\"Water Year\",las=1) \n mtext(side=2, expression(paste(\"Concentration, Inorganic Nitrogen, in mg  \",L^-1,sep=\"\")),line=4)\ndev.off()\n\n# ---------------------------\n# Now run the EGRETci package\n# ---------------------------\n\n# Change working directory\nsetwd(\"..\")\nsubDir <- 'EGRETci_plots'\nif (file.exists(subDir)){\n    setwd(file.path(getwd(),subDir))\n} else {\n    dir.create(file.path(getwd(),subDir), recursive=TRUE)\n    setwd(file.path(getwd(),subDir))\n}\n\n#Interactive function to set up trend analysis:\ncaseSetUp <- trendSetUp(eList, \n                        year1=1991, \n                        year2=2011, \n                        nBoot = 200, \n                        bootBreak = 100, \n                        blockLength = 200)\neBoot <- wBT(eList, caseSetUp, fileName =\"outputText_TP.txt\")\n\n#Should we reject Ho that Flow Normalized Concentration Trend = 0 ? Reject Ho\n#best estimate is -0.00392 mg/L\n#Lower and Upper 90% CIs -0.010593 -0.000426\n#also 95% CIs-0.012237  0.001596\n#and 50% CIs -0.006782 -0.002892\n#approximate two-sided p-value for Conc     0.074\n#Likelihood that Flow Normalized Concentration is trending up =     0.0324 is trending down =      0.968\n#\n#Should we reject Ho that Flow Normalized Flux Trend = 0 ? Do Not Reject Ho\n#best estimate is -0.0003109 10^6 kg/year\n#Lower and Upper 90% CIs -8.64e-04  1.02e-04\n#also 95% CIs -1.03e-03  2.64e-04\n#and 50% CIs -5.87e-04 -1.85e-04\n#approximate two-sided p-value for Flux      0.18\n#Likelihood that Flow Normalized Flux is trending up = 0.088 is trending down= 0.912\n#\n#Upward trend in concentration is highly unlikely\n#Upward trend in flux is very unlikely\n#Downward trend in concentration is highly likely\n#Downward trend in flux is very likely\n #                                                            \n#\n# \nsaveEGRETci(eList, eBoot, caseSetUp, fileName = \"EGRETci_output_TP\")\n\nplotHistogramTrend2 <-\nfunction (eBoot, caseSetUp, eList, xSeq = seq(-100, 100, 10), \n    flux = TRUE, printTitle = TRUE, cex.main = 1.1, col.fill = \"grey\", xlim = c(-100,100),\n    ...) \n{\n    bootOut <- eBoot$bootOut\n    INFO <- eList$INFO\n    if (flux) {\n        xFlux <- eBoot$xFlux\n        change <- 100 * bootOut$estF/bootOut$baseFlux\n        reps <- 100 * xFlux/bootOut$baseFlux\n        xlabel <- \"Flux trend, in %\"\n        titleWord <- \"Flux\"\n    }\n    else {\n        xConc <- eBoot$xConc\n        change <- 100 * bootOut$estC/bootOut$baseConc\n        reps <- 100 * xConc/bootOut$baseConc\n        xlabel <- \"Concentration trend, in %\"\n        titleWord <- \"Concentration\"\n    }\n    titleToPrint <- ifelse(printTitle, paste(\"Histogram of trend in\", \n        INFO$paramShortName, \"\\n\", titleWord, \"Normalized Concentration:\", \n        caseSetUp$year1, \"to\", caseSetUp$year2, \"\\n\", INFO$shortName), \n        \"\")\n    hist(reps, breaks = xSeq, yaxs = \"i\", xaxs = \"i\", tcl = 0.5, \n        main = titleToPrint, freq = FALSE, xlab = xlabel, col = col.fill, \n        cex.main = cex.main, xlim=xlim, ...)\n    abline(v = change, lwd = 3, lty = 2)\n    abline(v = 0, lwd = 3)\n    box()\n    axis(3, tcl = 0.5, labels = FALSE)\n    axis(4, tcl = 0.5, labels = FALSE)\n}\n\ntiff(\"histo_TP_UpTruck_Trend_conc_flux.tif\", height = 700, width = 1200, res=120)\n par(mfrow=c(1,2))\n plotHistogramTrend2(eBoot, caseSetUp, eList, flux=FALSE, xSeq = seq(-8000,8000,5),las=1,xlim=c(-100,100))\n abline(h=0)\n \n plotHistogramTrend2(eBoot, caseSetUp, eList, flux=TRUE, xSeq = seq(-50000,50000,5),las=1)\n abline(h=0)\ndev.off()\n\nnBoot <- 200\nblockLength <- 200\ncoreOut <- 5 #Number of cores to leave out of processing tasks\n\nwidthCI <- 95\nciLower <- (50-(widthCI/2))/100\nciUpper <- (50+(widthCI/2))/100\nprobs <- c(ciLower,ciUpper)\n\nnCores <- detectCores() - coreOut\ncl <- makeCluster(nCores)\nregisterDoParallel(cl)\nrepAnnual <- foreach(n = 1:nBoot,.packages=c('EGRETci')) %dopar% {\n   annualResults <- bootAnnual(eList, blockLength)  \n}\nstopCluster(cl)\n\nCIAnnualResults <- ciBands(eList, repAnnual, probs)\nconc.poly.x <- c(CIAnnualResults$Year,rev(CIAnnualResults$Year))\nconc.poly.y <- c(CIAnnualResults$FNConcLow,rev(CIAnnualResults$FNConcHigh))\nflux.poly.x <- c(CIAnnualResults$Year,rev(CIAnnualResults$Year))\nflux.poly.y <- c(CIAnnualResults$FNFluxLow*365,rev(CIAnnualResults$FNFluxHigh*365))\n\ntiff(\"Ann_Avg_Conc_&_Ann_Flow_Normalized_Conc_Boot_UpperTruckee_SupTruckUT5_TP.tif\", height = 500, width = 600, res=110)\n plotConcHistBoot(eList, CIAnnualResults, plotFlowNorm=TRUE, showYLabels=TRUE, showYAxis=TRUE,col=4)\n polygon(x=conc.poly.x, y=conc.poly.y, col=rgb(24,116,205,40,max=255),border=NA)\ndev.off()\n\ntiff(\"Ann_Flux_&_Ann_Flow_Normalized_Flux_Boot_UpperTruckee_SupTruckUT5_TP.tif\", height = 500, width = 600, res=110)\n plotFluxHistBoot(eList, fluxUnit=13, CIAnnualResults, showYLabels=TRUE, showYAxis=TRUE, col=4)\n polygon(x=flux.poly.x, y=flux.poly.y, col=rgb(24,116,205,40,max=255),border=NA)\ndev.off()\n\nsetSweave(\"UT5_TP_Conc_EGRETCI\",7,7)\nplotConcHistBoot(eList, CIAnnualResults, plotFlowNorm=TRUE, showYLabels=TRUE, showYAxis=TRUE,col=4)\npolygon(x=conc.poly.x, y=conc.poly.y, col=rgb(24,116,205,40,max=255),border=NA)\ngraphics.off()\n\nsetSweave(\"UT5_TP_Flux_EGRETCI\",7,7)\nplotFluxHistBoot(eList, fluxUnit=13, CIAnnualResults, showYLabels=TRUE, showYAxis=TRUE, col=4)\npolygon(x=flux.poly.x, y=flux.poly.y, col=rgb(24,116,205,40,max=255),border=NA)\ngraphics.off()\n\nsaveEGRETci(eList, eBoot, fileName=\"TP_Boot_SupTruckUT5.RData\")\nsave(repAnnual,file=\"RepAnnual\")\n\n# load(file=\"N_Boot.RData\")\n# load(file=\"RepAnnual\")\n\n\n#############################################################\n# Working on SSC\n#############################################################\nstartDate <- \"1990-06-01\"\nendDate <- \"2011-09-30\"\nsiteNumber <- \"10336580\"\nQParameterCd <- \"00060\"\nparameterCd <- \"80154\"  # \"SSC\"\nfileName <- \"UT5_SSC.csv\"\nDaily <- readNWISDaily(siteNumber, QParameterCd, startDate, endDate)\nSample <- readUserSample(filePath, fileName)\n#Sample <- readNWISSample(siteNumber, parameterCd, startDate, endDate)\nINFO <- readNWISInfo(siteNumber = siteNumber, parameterCd = parameterCd, interactive=FALSE)\nINFO$staAbbrev <- paste(strsplit(INFO$station_nm,\" \")[[1]][1],strsplit(INFO$station_nm,\" \")[[1]][2])\n\n# Have a look at the available range of TP data\nrange(Sample$Date)\n#\"1990-06-07\" \"2011-09-06\"\neList <- mergeReport(INFO, Daily, Sample)\n\n# Change the working directory; redirect plot output to NO3 folder\nsetwd(\"../..\")\nsubDir <- 'SSC/EGRET_plots'\nif (file.exists(subDir)){\n    setwd(file.path(getwd(),subDir))\n} else {\n    dir.create(file.path(getwd(),subDir), recursive=TRUE)\n    setwd(file.path(getwd(),subDir))\n}\nplotConcTime(eList)\n# Plot water quality data\ntiff(\"Conc_vs_Time_UpperTruckee_SupTruckUT5_SSC.tif\", height = 600, width = 800, res=120)\n  plotConcTime(eList)\ndev.off()\n\n# Now, a classic Q-C plot\ntiff(\"Conc-Q_UpperTruckee_SupTruckUT5_SSC.tif\", height = 600, width = 800, res=120)\n  plotConcQ(eList, logScale=TRUE)\ndev.off()\n\n# The data set as flux values rather than as concentrations\ntiff(\"Flux-Q_UpperTruckee_SupTruckUT5_SSC.tif\", height = 600, width = 800, res=120)\n  plotFluxQ(eList, fluxUnit=4)\ndev.off()\n\n# Monthly boxplots\ntiff(\"Monthly-Conc_BoxPlots_UpperTruckee_SupTruckUT5_SSC.tif\", height = 600, width = 800, res=120)\n  boxConcMonth(eList, logScale=TRUE)\ndev.off()\n\n# Flow on days sampled vs. all other days\ntiff(\"Flow_on_days_sampled_vs_all_other_days_UpperTruckee_SupTruckUT5_SSC.tif\", height = 600, width = 800, res=120)\n  boxQTwice(eList, qUnit=1)\ndev.off()\n\n#########################################\n# Now start the Flow-Normalized Analysis\n#########################################\n\n# Build the regression model\neList <- modelEstimation(eList, windowY = 7, windowQ = 2, windowS = 0.5, minNumObs = 100, minNumUncen =50)\n\nMonthlyResults <- calculateMonthlyResults(eList)\n\n# Plot the annual average concentration and annual flow-normalized concentration\ntiff(\"Ann_Avg_Conc_&_Ann_Flow_Normalized_Conc_UpperTruckee_SupTruckUT5_SSC.tif\", height = 600, width = 800, res=120)\n  plotConcHist(eList, plotFlowNorm=TRUE)\ndev.off()\n\n# Plot the annual flux and annual flow-normalized flux\ntiff(\"Ann_Flux_&_Ann_Flow_Normalized_Flux_UpperTruckee_SupTruckUT5_SSC.tif\", height = 600, width = 800, res=120)\n  plotFluxHist(eList, plotFlowNorm = TRUE) # fluxMax) # fluxMax\ndev.off()\n\n# Look for a trend change:\ntableChange(eList, fluxUnit=6, yearPoints=c(1990,1998,2011))\n\n#UPPER TRUCKEE RV AT S UPPER TRUCKEE RD NR MEYERS \n#Suspended sediment concentration (SSC)\n#Water Year \n#\n#Concentration trends\n#time span       change     slope    change     slope\n#mg/L   mg/L/yr        %       %/yr\n#\n#1991  to  1996      -3.8     -0.75       -53       -11\n#1991  to  2001      -4.1     -0.41       -58      -5.8\n#1991  to  2006      -3.9     -0.26       -55      -3.7\n#1991  to  2011      -3.8     -0.19       -53      -2.7\n#1996  to  2001     -0.38    -0.076       -11      -2.3\n#1996  to  2006     -0.15    -0.015      -4.5     -0.45\n#1996  to  2011   -0.0058  -0.00038     -0.17    -0.011\n#2001  to  2006      0.23     0.046       7.8       1.6\n#2001  to  2011      0.38     0.038        13       1.3\n#2006  to  2011      0.14     0.029       4.5       0.9\n#\n#\n#Flux Trends\n#time span          change        slope       change        slope\n#10^3 tons/yr   10^3 tons/yr /yr      %         %/yr\n#1991  to  1996        -0.62        -0.12          -59          -12\n#1991  to  2001        -0.67       -0.067          -63         -6.3\n#1991  to  2006        -0.62       -0.041          -59         -3.9\n#1991  to  2011        -0.52       -0.026          -49         -2.5\n#1996  to  2001       -0.043      -0.0085          -10           -2\n#1996  to  2006       0.0045      0.00045          1.1         0.11\n#1996  to  2011         0.11       0.0072           25          1.7\n#2001  to  2006        0.047       0.0095           12          2.5\n#2001  to  2011         0.15        0.015           39          3.9\n#2006  to  2011          0.1        0.021           24          4.8\n#\n#Generate out-of-the-box diagnostic plots\ntiff(\"fluxBiasMulti_UpperTruckee_SupTruckUT5_SSC.tif\", height = 1200, width = 1000, res=120)\n fluxBiasMulti(eList, moreTitle = \"WRTDS\")\ndev.off()\n\ntiff(\"Modeled_Daily_Conc_wObservations_UpperTruckee_SupTruckUT5_SSC.tif\", height = 800, width = 1000, res=120)\n plotConcTimeDaily(eList)\ndev.off()\n\n# Exploring model behavior and adjusting model parameters\ntiff(\"Contours_UpperTruckee_SupTruckUT5_SSC.tif\", height = 700, width = 1000, res=120)\n plotContours(eList, qBottom=0.03,qTop=10,yearStart=1990,yearEnd=2011, contourLevels=seq(0,50,by=1), color.palette = colorRampPalette(c(\"violet\", \"purple\", \"blue\", \"cyan\", \"green\", \"yellow\", \"orange\", \"red\"))) \ndev.off()\n\ntiff(\"Log_Contours_UpperTruckee_SupTruckUT5_SSC.tif\", height = 700, width = 1000, res=120)\n plotContours(eList, qBottom=0.03, qTop=10, yearStart=1990, yearEnd=2011, contourLevels=seq(-2.4,4,by=0.1), color.palette = colorRampPalette(c(\"violet\", \"purple\", \"blue\", \"cyan\", \"green\", \"yellow\", \"orange\", \"red\")), whatSurface=1) \ndev.off()\n\ntiff(\"StdErr_of_Log_Contours_UpperTruckee_SupTruckUT5_SSC.tif\", height = 700, width = 1000, res=120)\n plotContours(eList, qBottom=0.03, qTop=10, yearStart=1990, yearEnd=2011, contourLevels=seq(0.38,0.98,by=0.01), color.palette = colorRampPalette(c(\"violet\", \"purple\", \"blue\", \"cyan\", \"green\", \"yellow\", \"orange\", \"red\")), whatSurface=2) \ndev.off()\n\ntiff(\"Contours_Difference_SupTruckUT5_SSC.tif\", height = 700, width = 1000, res=120)\n plotDiffContours(eList, 1990,2011,0.03,10,maxDiff=50)\ndev.off()\n\ntiff(\"Contours_PercentDifference_SupTruckUT5_SSC.tif\", height = 700, width = 1000, res=120)\n plotDiffContours(eList, 1990,2011,0.03,10, maxDiff=100, plotPercent=TRUE)\ndev.off()\n\ntiff(\"Contours_PercentDifference2_SSC_UPperTruckee_SupTruckUT5.tif\", height = 700, width = 1000, res=120)\n plotDiffContours2(eList, 1990,2011,0.05,10, maxDiff=c(-100,100), plotPercent=TRUE, lwd=3, color.palette=colorRampPalette(c(\"blue\",\"lightblue\",\"white\",\"yellow\", \"orange\", \"red\")),tick.lwd = 1)\ndev.off()\n\nSample$WY <- trunc(Sample$DecYear+0.25) \ntiff(\"Monthly_Boxplot_Inorg_SSC_UpperTruckee_SupTruckUT5.tif\", height = 700, width = 1000, res=120)\n par(mar=c(4,6,0.5,0.5))\n boxplot(Sample$ConcAve~Sample$WY,log=\"y\",varwidth=TRUE,ylim=c(0.1,1000),yaxs=\"i\",xlab=\"Water Year\",las=1) \n mtext(side=2, expression(paste(\"Concentration, Inorganic Nitrogen, in mg  \",L^-1,sep=\"\")),line=4)\ndev.off()\n\n\n# ---------------------------\n# Now run the EGRETci package\n# ---------------------------\n\n# Change working directory\nsetwd(\"..\")\nsubDir <- 'EGRETci_plots'\nif (file.exists(subDir)){\n    setwd(file.path(getwd(),subDir))\n} else {\n    dir.create(file.path(getwd(),subDir), recursive=TRUE)\n    setwd(file.path(getwd(),subDir))\n}\n\n#Interactive function to set up trend analysis:\ncaseSetUp <- trendSetUp(eList, \n                        year1=1991, \n                        year2=2011, \n                        nBoot = 200, \n                        bootBreak = 100, \n                        blockLength = 200)\neBoot <- wBT(eList, caseSetUp, fileName =\"outputText.txt\")\n#\n#Should we reject Ho that Flow Normalized Concentration Trend = 0 ? Do Not Reject Ho\n#best estimate is   -3.77 mg/L\n#Lower and Upper 90% CIs    -9.81    85.81\n#also 95% CIs  -35.60  1593.68\n#and 50% CIs    -5.90    -2.51\n#approximate two-sided p-value for Conc      0.17\n#Likelihood that Flow Normalized Concentration is trending up =     0.0842 is trending down =      0.916\n#\n#Should we reject Ho that Flow Normalized Flux Trend = 0 ? Do Not Reject Ho\n#best estimate is  -0.4692 10^6 kg/year\n#Lower and Upper 90% CIs   -2.916   48.136\n#also 95% CIs  -12.099  705.523\n#and 50% CIs   -0.915   -0.314\n#approximate two-sided p-value for Flux      0.22\n#Likelihood that Flow Normalized Flux is trending up = 0.114 is trending down= 0.886\n#\n#Upward trend in concentration is very unlikely\n#Upward trend in flux is unlikely\n#Downward trend in concentration is very likely\n#Downward trend in flux is likely                             \n#\n \nsaveEGRETci(eList, eBoot, caseSetUp, fileName = \"EGRETci_output_SSC_SupTruckUT5.RData\")\n\nplotHistogramTrend2 <-\nfunction (eBoot, caseSetUp, eList, xSeq = seq(-100, 100, 10), \n    flux = TRUE, printTitle = TRUE, cex.main = 1.1, col.fill = \"grey\", xlim = c(-100,100),\n    ...) \n{\n    bootOut <- eBoot$bootOut\n    INFO <- eList$INFO\n    if (flux) {\n        xFlux <- eBoot$xFlux\n        change <- 100 * bootOut$estF/bootOut$baseFlux\n        reps <- 100 * xFlux/bootOut$baseFlux\n        xlabel <- \"Flux trend, in %\"\n        titleWord <- \"Flux\"\n    }\n    else {\n        xConc <- eBoot$xConc\n        change <- 100 * bootOut$estC/bootOut$baseConc\n        reps <- 100 * xConc/bootOut$baseConc\n        xlabel <- \"Concentration trend, in %\"\n        titleWord <- \"Concentration\"\n    }\n    titleToPrint <- ifelse(printTitle, paste(\"Histogram of trend in\", \n        INFO$paramShortName, \"\\n\", titleWord, \"Normalized Concentration:\", \n        caseSetUp$year1, \"to\", caseSetUp$year2, \"\\n\", INFO$shortName), \n        \"\")\n    hist(reps, breaks = xSeq, yaxs = \"i\", xaxs = \"i\", tcl = 0.5, \n        main = titleToPrint, freq = FALSE, xlab = xlabel, col = col.fill, \n        cex.main = cex.main, xlim=xlim, ...)\n    abline(v = change, lwd = 3, lty = 2)\n    abline(v = 0, lwd = 3)\n    box()\n    axis(3, tcl = 0.5, labels = FALSE)\n    axis(4, tcl = 0.5, labels = FALSE)\n}\n\ntiff(\"histo_SSC_SupTruckUT5_Trend_conc_flux.tif\", height = 700, width = 1200, res=120)\n par(mfrow=c(1,2))\n plotHistogramTrend2(eBoot, caseSetUp, eList, flux=FALSE, xSeq = seq(-800000,8000000,5),las=1,xlim=c(-150,50))\n abline(h=0)\n \n plotHistogramTrend2(eBoot, caseSetUp, eList, flux=TRUE, xSeq = seq(-5000000,50000000,5),las=1,xlim=c(-200,200))\n abline(h=0)\ndev.off()\n\nnBoot <- 200\nblockLength <- 200\ncoreOut <- 5 #Number of cores to leave out of processing tasks\n\nwidthCI <- 95\nciLower <- (50-(widthCI/2))/100\nciUpper <- (50+(widthCI/2))/100\nprobs <- c(ciLower,ciUpper)\n\nnCores <- detectCores() - coreOut\ncl <- makeCluster(nCores)\nregisterDoParallel(cl)\nrepAnnual <- foreach(n = 1:nBoot,.packages=c('EGRETci')) %dopar% {\n   annualResults <- bootAnnual(eList, blockLength)  \n}\nstopCluster(cl)\n\nCIAnnualResults <- ciBands(eList, repAnnual, probs)\nconc.poly.x <- c(CIAnnualResults$Year,rev(CIAnnualResults$Year))\nconc.poly.y <- c(CIAnnualResults$FNConcLow,rev(CIAnnualResults$FNConcHigh))\nflux.poly.x <- c(CIAnnualResults$Year,rev(CIAnnualResults$Year))\nflux.poly.y <- c(CIAnnualResults$FNFluxLow*365,rev(CIAnnualResults$FNFluxHigh*365))\n\ntiff(\"Ann_Avg_Conc_&_Ann_Flow_Normalized_Conc_Boot_UpperTruckee_SupTruckUT5_SSC.tif\", height = 500, width = 600, res=110)\n plotConcHistBoot(eList, CIAnnualResults, plotFlowNorm=TRUE, showYLabels=TRUE, showYAxis=TRUE,col=4)\n polygon(x=conc.poly.x, y=conc.poly.y, col=rgb(24,116,205,40,max=255),border=NA)\ndev.off()\n\ntiff(\"Ann_Flux_&_Ann_Flow_Normalized_Flux_Boot_UpperTruckee_SupTruckUT5_SSC.tif\", height = 500, width = 600, res=110)\n plotFluxHistBoot(eList, fluxUnit=13, CIAnnualResults, showYLabels=TRUE, showYAxis=TRUE, col=4)\n polygon(x=flux.poly.x, y=flux.poly.y, col=rgb(24,116,205,40,max=255),border=NA)\ndev.off()\n\nsetSweave(\"UT5_Conc_SSC_EGRETCI\",7,7)\nplotConcHistBoot(eList, CIAnnualResults, plotFlowNorm=TRUE, showYLabels=TRUE, showYAxis=TRUE,col=4)\npolygon(x=conc.poly.x, y=conc.poly.y, col=rgb(24,116,205,40,max=255),border=NA)\ngraphics.off()\n\nsetSweave(\"UT5_Flux_SSC_EGRETCI\",7,7)\nplotFluxHistBoot(eList, fluxUnit=13, CIAnnualResults, showYLabels=TRUE, showYAxis=TRUE, col=4)\npolygon(x=flux.poly.x, y=flux.poly.y, col=rgb(24,116,205,40,max=255),border=NA)\ngraphics.off()\n\n\nsaveEGRETci(eList, eBoot, fileName=\"SSC_Boot_SupTruckUT5.RData\")\nsave(repAnnual,file=\"RepAnnual\")\n\n# load(file=\"N_Boot.RData\")\n# load(file=\"RepAnnual\")\n\n\n#############################################################\n# Working on NH4\n#############################################################\nstartDate <- \"1990-06-01\"\nendDate <- \"2011-09-30\"\nsiteNumber <- \"10336580\"\nQParameterCd <- \"00060\"\nparameterCd <- \"00608\"  # \"NH4\"\nfileName <- \"UT5_NH4.csv\"\nDaily <- readNWISDaily(siteNumber, QParameterCd, startDate, endDate)\nSample <- readUserSample(filePath, fileName)\n#Sample <- readNWISSample(siteNumber, parameterCd, startDate, endDate)\nINFO <- readNWISInfo(siteNumber = siteNumber, parameterCd = parameterCd, interactive=FALSE)\nINFO$staAbbrev <- paste(strsplit(INFO$station_nm,\" \")[[1]][1],strsplit(INFO$station_nm,\" \")[[1]][2])\n\n# Have a look at the available range of NH3 data\nrange(Sample$Date)\n#\"1990-06-07\" \"2011-09-06\"\neList <- mergeReport(INFO, Daily, Sample)\n\n# Change the working directory; redirect plot output to NH4 folder\nsetwd(\"../..\")\nsubDir <- 'NH4/EGRET_plots'\nif (file.exists(subDir)){\n  setwd(file.path(getwd(),subDir))\n} else {\n  dir.create(file.path(getwd(),subDir), recursive=TRUE)\n  setwd(file.path(getwd(),subDir))\n}\nplotConcTime(eList)\n# Plot water quality data\ntiff(\"Conc_vs_Time_UpperTruckee_SupTruckUT5_NH4.tif\", height = 600, width = 800, res=120)\nplotConcTime(eList)\ndev.off()\n\n# Now, a classic Q-C plot\ntiff(\"Conc-Q_UpperTruckee_SupTruckUT5_NH4.tif\", height = 600, width = 800, res=120)\nplotConcQ(eList, logScale=TRUE)\ndev.off()\n\n# The data set as flux values rather than as concentrations\ntiff(\"Flux-Q_UpperTruckee_SupTruckUT5_NH4.tif\", height = 600, width = 800, res=120)\nplotFluxQ(eList, fluxUnit=4)\ndev.off()\n\n# Monthly boxplots\ntiff(\"Monthly-Conc_BoxPlots_UpperTruckee_SupTruckUT5_NH4.tif\", height = 600, width = 800, res=120)\nboxConcMonth(eList, logScale=TRUE)\ndev.off()\n\n# Flow on days sampled vs. all other days\ntiff(\"Flow_on_days_sampled_vs_all_other_days_UpperTruckee_SupTruckUT5_NH4.tif\", height = 600, width = 800, res=120)\nboxQTwice(eList, qUnit=1)\ndev.off()\n\n#########################################\n# Now start the Flow-Normalized Analysis\n#########################################\n\n# Build the regression model\neList <- modelEstimation(eList, windowY = 7, windowQ = 2, windowS = 0.5, minNumObs = 100, minNumUncen =50)\n\nMonthlyResults <- calculateMonthlyResults(eList)\n\n# Plot the annual average concentration and annual flow-normalized concentration\ntiff(\"Ann_Avg_Conc_&_Ann_Flow_Normalized_Conc_UpperTruckee_SupTruckUT5_NH4.tif\", height = 600, width = 800, res=120)\nplotConcHist(eList, plotFlowNorm=TRUE)\ndev.off()\n\n# Plot the annual flux and annual flow-normalized flux\ntiff(\"Ann_Flux_&_Ann_Flow_Normalized_Flux_UpperTruckee_SupTruckUT5_NH4.tif\", height = 600, width = 800, res=120)\nplotFluxHist(eList, plotFlowNorm = TRUE) # fluxMax) # fluxMax\ndev.off()\n\n# Look for a trend change:\ntableChange(eList, fluxUnit=6, yearPoints=c(1990,1998,2011))\n\n#UPPER TRUCKEE RV AT S UPPER TRUCKEE RD NR MEYERS \n#Ammonia and ammonium\n#Water Year \n#\n#Concentration trends\n#time span       change     slope    change     slope\n#mg/L   mg/L/yr        %       %/yr\n#\n#1991  to  1996  -0.00068  -0.00014       -19      -3.9\n#1991  to  2001  -0.00064  -6.4e-05       -18      -1.8\n#1991  to  2006   3.6e-05   2.4e-06         1     0.068\n#1991  to  2011   0.00077   3.9e-05        22       1.1\n#1996  to  2001     4e-05     8e-06       1.4      0.29\n#1996  to  2006   0.00072   7.2e-05        25       2.5\n#1996  to  2011    0.0015   9.7e-05        51       3.4\n#2001  to  2006   0.00068   0.00014        24       4.7\n#2001  to  2011    0.0014   0.00014        49       4.9\n#2006  to  2011   0.00074   0.00015        21       4.2\n#\n#\n#Flux Trends\n#time span          change        slope       change        slope\n#10^3 tons/yr   10^3 tons/yr /yr      %         %/yr\n#1991  to  1996     -2.1e-05     -4.2e-06          -19         -3.9\n#1991  to  2001     -1.1e-05     -1.1e-06         -9.6        -0.96\n#1991  to  2006        1e-05      6.8e-07          9.2         0.61\n#1991  to  2011      2.7e-05      1.3e-06           24          1.2\n#1996  to  2001      1.1e-05      2.1e-06           12          2.4\n#1996  to  2006      3.1e-05      3.1e-06           35          3.5\n#1996  to  2011      4.8e-05      3.2e-06           54          3.6\n#2001  to  2006      2.1e-05      4.2e-06           21          4.2\n#2001  to  2011      3.7e-05      3.7e-06           37          3.7\n#2006  to  2011      1.6e-05      3.3e-06           14          2.7\n#\n#Generate out-of-the-box diagnostic plots\ntiff(\"fluxBiasMulti_UpperTruckee_SupTruckUT5_NH4.tif\", height = 1200, width = 1000, res=120)\nfluxBiasMulti(eList, moreTitle = \"WRTDS\")\ndev.off()\n\ntiff(\"Modeled_Daily_Conc_wObservations_UpperTruckee_SupTruckUT5_NH4.tif\", height = 800, width = 1000, res=120)\nplotConcTimeDaily(eList)\ndev.off()\n\n# Exploring model behavior and adjusting model parameters\ntiff(\"Contours_UpperTruckee_SupTruckUT5_NH4.tif\", height = 700, width = 1000, res=120)\nplotContours(eList, qBottom=0.03,qTop=10,yearStart=1990,yearEnd=2011, contourLevels=seq(0,50,by=1), color.palette = colorRampPalette(c(\"violet\", \"purple\", \"blue\", \"cyan\", \"green\", \"yellow\", \"orange\", \"red\"))) \ndev.off()\n\ntiff(\"Log_Contours_UpperTruckee_SupTruckUT5_NH4.tif\", height = 700, width = 1000, res=120)\nplotContours(eList, qBottom=0.03, qTop=10, yearStart=1990, yearEnd=2011, contourLevels=seq(-2.4,4,by=0.1), color.palette = colorRampPalette(c(\"violet\", \"purple\", \"blue\", \"cyan\", \"green\", \"yellow\", \"orange\", \"red\")), whatSurface=1) \ndev.off()\n\ntiff(\"StdErr_of_Log_Contours_UpperTruckee_SupTruckUT5_NH4.tif\", height = 700, width = 1000, res=120)\nplotContours(eList, qBottom=0.03, qTop=10, yearStart=1990, yearEnd=2011, contourLevels=seq(0.38,0.98,by=0.01), color.palette = colorRampPalette(c(\"violet\", \"purple\", \"blue\", \"cyan\", \"green\", \"yellow\", \"orange\", \"red\")), whatSurface=2) \ndev.off()\n\ntiff(\"Contours_Difference_SupTruckUT5_NH4.tif\", height = 700, width = 1000, res=120)\nplotDiffContours(eList, 1990,2011,0.03,10,maxDiff=50)\ndev.off()\n\ntiff(\"Contours_PercentDifference_SupTruckUT5_NH4.tif\", height = 700, width = 1000, res=120)\nplotDiffContours(eList, 1990,2011,0.03,10, maxDiff=100, plotPercent=TRUE)\ndev.off()\n\ntiff(\"Contours_PercentDifference2_NH4_UPperTruckee_SupTruckUT5.tif\", height = 700, width = 1000, res=120)\nplotDiffContours2(eList, 1990,2011,0.05,10, maxDiff=c(-100,100), plotPercent=TRUE, lwd=3, color.palette=colorRampPalette(c(\"blue\",\"lightblue\",\"white\",\"yellow\", \"orange\", \"red\")),tick.lwd = 1)\ndev.off()\n\nSample$WY <- trunc(Sample$DecYear+0.25) \ntiff(\"Monthly_Boxplot_Inorg_NH4_UpperTruckee_SupTruckUT5.tif\", height = 700, width = 1000, res=120)\npar(mar=c(4,6,0.5,0.5))\nboxplot(Sample$ConcAve~Sample$WY,log=\"y\",varwidth=TRUE,ylim=c(0.1,1000),yaxs=\"i\",xlab=\"Water Year\",las=1) \nmtext(side=2, expression(paste(\"Concentration, Inorganic Nitrogen, in mg  \",L^-1,sep=\"\")),line=4)\ndev.off()\n\n\n# ---------------------------\n# Now run the EGRETci package\n# ---------------------------\n\n# Change working directory\nsetwd(\"..\")\nsubDir <- 'EGRETci_plots'\nif (file.exists(subDir)){\n  setwd(file.path(getwd(),subDir))\n} else {\n  dir.create(file.path(getwd(),subDir), recursive=TRUE)\n  setwd(file.path(getwd(),subDir))\n}\n\n#Interactive function to set up trend analysis:\ncaseSetUp <- trendSetUp(eList, \n                        year1=1991, \n                        year2=2011, \n                        nBoot = 200, \n                        bootBreak = 100, \n                        blockLength = 200)\neBoot <- wBT(eList, caseSetUp, fileName =\"outputText.txt\")\n#\n#UPPER TRUCKEE RV AT S UPPER TRUCKEE RD NR MEYERS \n#Ammonia and ammonium\n#Water Year \n#\n#Concentration trends\n#time span       change     slope    change     slope\n#mg/L   mg/L/yr        %       %/yr\n#\n#1991  to  1996  -0.00068  -0.00014       -19      -3.9\n#1991  to  2001  -0.00064  -6.4e-05       -18      -1.8\n#1991  to  2006   3.6e-05   2.4e-06         1     0.068\n#1991  to  2011   0.00077   3.9e-05        22       1.1\n#1996  to  2001     4e-05     8e-06       1.4      0.29\n#996  to  2006   0.00072   7.2e-05        25       2.5\n#1996  to  2011    0.0015   9.7e-05        51       3.4\n#2001  to  2006   0.00068   0.00014        24       4.7\n#2001  to  2011    0.0014   0.00014        49       4.9\n#2006  to  2011   0.00074   0.00015        21       4.2\n#\n#\n#Flux Trends\n#time span          change        slope       change        slope\n#10^3 tons/yr   10^3 tons/yr /yr      %         %/yr\n#1991  to  1996     -2.1e-05     -4.2e-06          -19         -3.9\n#1991  to  2001     -1.1e-05     -1.1e-06         -9.6        -0.96\n#1991  to  2006        1e-05      6.8e-07          9.2         0.61\n#1991  to  2011      2.7e-05      1.3e-06           24          1.2\n#1996  to  2001      1.1e-05      2.1e-06           12          2.4\n#1996  to  2006      3.1e-05      3.1e-06           35          3.5\n#1996  to  2011      4.8e-05      3.2e-06           54          3.6\n#2001  to  2006      2.1e-05      4.2e-06           21          4.2\n#2001  to  2011      3.7e-05      3.7e-06           37          3.7\n#2006  to  2011      1.6e-05      3.3e-06           14          2.7\n#\nsaveEGRETci(eList, eBoot, caseSetUp, fileName = \"EGRETci_output_SSC_SupTruckUT5.RData\")\n\nplotHistogramTrend2 <-\n  function (eBoot, caseSetUp, eList, xSeq = seq(-100, 100, 10), \n            flux = TRUE, printTitle = TRUE, cex.main = 1.1, col.fill = \"grey\", xlim = c(-100,100),\n            ...) \n  {\n    bootOut <- eBoot$bootOut\n    INFO <- eList$INFO\n    if (flux) {\n      xFlux <- eBoot$xFlux\n      change <- 100 * bootOut$estF/bootOut$baseFlux\n      reps <- 100 * xFlux/bootOut$baseFlux\n      xlabel <- \"Flux trend, in %\"\n      titleWord <- \"Flux\"\n    }\n    else {\n      xConc <- eBoot$xConc\n      change <- 100 * bootOut$estC/bootOut$baseConc\n      reps <- 100 * xConc/bootOut$baseConc\n      xlabel <- \"Concentration trend, in %\"\n      titleWord <- \"Concentration\"\n    }\n    titleToPrint <- ifelse(printTitle, paste(\"Histogram of trend in\", \n                                             INFO$paramShortName, \"\\n\", titleWord, \"Normalized Concentration:\", \n                                             caseSetUp$year1, \"to\", caseSetUp$year2, \"\\n\", INFO$shortName), \n                           \"\")\n    hist(reps, breaks = xSeq, yaxs = \"i\", xaxs = \"i\", tcl = 0.5, \n         main = titleToPrint, freq = FALSE, xlab = xlabel, col = col.fill, \n         cex.main = cex.main, xlim=xlim, ...)\n    abline(v = change, lwd = 3, lty = 2)\n    abline(v = 0, lwd = 3)\n    box()\n    axis(3, tcl = 0.5, labels = FALSE)\n    axis(4, tcl = 0.5, labels = FALSE)\n  }\n\ntiff(\"histo_NH4_SupTruckUT5_Trend_conc_flux.tif\", height = 700, width = 1200, res=120)\npar(mfrow=c(1,2))\nplotHistogramTrend2(eBoot, caseSetUp, eList, flux=FALSE, xSeq = seq(-800000,8000000,5),las=1,xlim=c(-150,50))\nabline(h=0)\n\nplotHistogramTrend2(eBoot, caseSetUp, eList, flux=TRUE, xSeq = seq(-5000000,50000000,5),las=1,xlim=c(-200,200))\nabline(h=0)\ndev.off()\n\nnBoot <- 200\nblockLength <- 200\ncoreOut <- 5 #Number of cores to leave out of processing tasks\n\nwidthCI <- 95\nciLower <- (50-(widthCI/2))/100\nciUpper <- (50+(widthCI/2))/100\nprobs <- c(ciLower,ciUpper)\n\nnCores <- detectCores() - coreOut\ncl <- makeCluster(nCores)\nregisterDoParallel(cl)\nrepAnnual <- foreach(n = 1:nBoot,.packages=c('EGRETci')) %dopar% {\n  annualResults <- bootAnnual(eList, blockLength)  \n}\nstopCluster(cl)\n\nCIAnnualResults <- ciBands(eList, repAnnual, probs)\nconc.poly.x <- c(CIAnnualResults$Year,rev(CIAnnualResults$Year))\nconc.poly.y <- c(CIAnnualResults$FNConcLow,rev(CIAnnualResults$FNConcHigh))\nflux.poly.x <- c(CIAnnualResults$Year,rev(CIAnnualResults$Year))\nflux.poly.y <- c(CIAnnualResults$FNFluxLow*365,rev(CIAnnualResults$FNFluxHigh*365))\n\ntiff(\"Ann_Avg_Conc_&_Ann_Flow_Normalized_Conc_Boot_UpperTruckee_SupTruckUT5_NH4.tif\", height = 500, width = 600, res=110)\nplotConcHistBoot(eList, CIAnnualResults, plotFlowNorm=TRUE, showYLabels=TRUE, showYAxis=TRUE,col=4)\npolygon(x=conc.poly.x, y=conc.poly.y, col=rgb(24,116,205,40,max=255),border=NA)\ndev.off()\n\ntiff(\"Ann_Flux_&_Ann_Flow_Normalized_Flux_Boot_UpperTruckee_SupTruckUT5_NH4.tif\", height = 500, width = 600, res=110)\nplotFluxHistBoot(eList, fluxUnit=13, CIAnnualResults, showYLabels=TRUE, showYAxis=TRUE, col=4)\npolygon(x=flux.poly.x, y=flux.poly.y, col=rgb(24,116,205,40,max=255),border=NA)\ndev.off()\n\nsetSweave(\"UT5_Conc_NH4_EGRETCI\",7,7)\nplotConcHistBoot(eList, CIAnnualResults, plotFlowNorm=TRUE, showYLabels=TRUE, showYAxis=TRUE,col=4)\npolygon(x=conc.poly.x, y=conc.poly.y, col=rgb(24,116,205,40,max=255),border=NA)\ngraphics.off()\n\nsetSweave(\"UT5_Flux_NH4_EGRETCI\",7,7)\nplotFluxHistBoot(eList, fluxUnit=13, CIAnnualResults, showYLabels=TRUE, showYAxis=TRUE, col=4)\npolygon(x=flux.poly.x, y=flux.poly.y, col=rgb(24,116,205,40,max=255),border=NA)\ngraphics.off()\n\n\nsaveEGRETci(eList, eBoot, fileName=\"NH4_Boot_SupTruckUT5.RData\")\nsave(repAnnual,file=\"RepAnnual\")\n\n# load(file=\"N_Boot.RData\")\n# load(file=\"RepAnnual\")",
    "created" : 1489002263484.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "652187533",
    "id" : "28905B34",
    "lastKnownWriteTime" : 1507245789,
    "last_content_update" : 1507245789563,
    "path" : "~/LTIMP_TA/LTIMP_TA2/EGRET/UT5/UpTruck_EGRET_Analysis_Script.R",
    "project_path" : "UpTruck_EGRET_Analysis_Script.R",
    "properties" : {
    },
    "relative_order" : 1,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}